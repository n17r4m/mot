{"version":3,"sources":["/tools/runners/run-log.js"],"names":["_","require","Console","fiberHelpers","_Log","getLoggingPackage","loadIsopackage","Log","outputFormat","RunLog","self","rawLogs","messages","maxLength","consecutiveRestartMessages","consecutiveClientRestartMessages","temporaryMessageLength","extend","prototype","_record","msg","push","length","shift","_clearSpecial","info","spaces","Array","join","process","stdout","write","CARRIAGE_RETURN","setRawLogs","logAppOutput","line","isStderr","obj","objFromText","level","stderr","parse","noYieldsAllowed","rawInfo","format","color","log","options","time","Date","message","arrow","logTemporary","logRestart","pop","logClientRestart","finish","clearLog","getLog","runLogInstance","each","method","exports","bind"],"mappings":"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","file":"tools/runners/run-log.js.map","sourcesContent":["var _ = require('underscore');\nvar Console = require('../console/console.js').Console;\nvar fiberHelpers = require('../utils/fiber-helpers.js');\n\n// runLog is primarily used by the parts of the tool which run apps locally. It\n// writes to standard output (and standard error, if rawLogs is set), and allows\n// special output forms like \"write this line, but let the next line overwrite\n// it\". It also makes its output available to the proxy, to be displayed to web\n// browsers if the app fails to run.\n//\n// It's not the only mechanism used for gathering messages! buildmessage is a\n// more structured way of gathering messages, but unlike log, it does not print\n// messages immediately.\n//\n// Some other parts of the code (eg commands and warehouse) write directly to\n// process.std{out,err} or to console.log; we should be careful to not do that\n// anywhere that may overlap with use of runLog.\n\nlet _Log;\nfunction getLoggingPackage() {\n  if (! _Log) {\n    _Log = require(\"../tool-env/isopackets.js\")\n      .loadIsopackage('logging')\n      .Log;\n  }\n\n  // Since no other process will be listening to stdout and parsing it,\n  // print directly in the same format as log messages from other apps\n  _Log.outputFormat = 'colored-text';\n\n  return _Log;\n};\n\nvar RunLog = function () {\n  var self = this;\n\n  self.rawLogs = false;\n\n  self.messages = []; // list of log objects\n  self.maxLength = 100;\n\n  // If non-null, the last thing logged was \"server restarted\"\n  // message, and the value will be the number of consecutive such\n  // messages that have been logged with no other intervening messages\n  self.consecutiveRestartMessages = null;\n  self.consecutiveClientRestartMessages = null;\n\n  // If non-null, the last thing that was logged was a temporary\n  // message (with a carriage return but no newline), and this is its\n  // length.\n  self.temporaryMessageLength = null;\n};\n\n_.extend(RunLog.prototype, {\n  _record: function (msg) {\n    var self = this;\n\n    self.messages.push(msg);\n    if (self.messages.length > self.maxLength) {\n      self.messages.shift();\n    }\n  },\n\n  _clearSpecial: function () {\n    var self = this;\n\n    if (self.consecutiveRestartMessages) {\n      self.consecutiveRestartMessages = null;\n      Console.info();\n    }\n\n    if (self.consecutiveClientRestartMessages) {\n      self.consecutiveClientRestartMessages = null;\n      Console.info();\n    }\n\n    if (self.temporaryMessageLength) {\n      var spaces = new Array(self.temporaryMessageLength + 1).join(' ');\n      process.stdout.write(spaces + Console.CARRIAGE_RETURN);\n      self.temporaryMessageLength = null;\n    }\n  },\n\n  setRawLogs: function (rawLogs) {\n    this.rawLogs = !!rawLogs;\n  },\n\n  logAppOutput: function (line, isStderr) {\n    var self = this;\n\n    var Log = getLoggingPackage();\n\n    var obj = (isStderr ?\n               Log.objFromText(line, { level: 'warn', stderr: true }) :\n               Log.parse(line) || Log.objFromText(line));\n    self._record(obj);\n\n    self._clearSpecial();\n    if (self.rawLogs) {\n      Console[isStderr ? \"rawError\" : \"rawInfo\"](line + \"\\n\");\n    } else {\n      // XXX deal with test server logging differently?!\n      return fiberHelpers.noYieldsAllowed(function() {\n        Console.rawInfo(Log.format(obj, { color: true }) + \"\\n\");\n      });\n    }\n  },\n\n  // Log the message.\n  //  msg: message\n  //  options:\n  //    - arrow: if true, preface with => and wrap accordingly.\n  log: function (msg, options) {\n    var self = this;\n    options = options || {};\n    var obj = {\n      time: new Date,\n      message: msg\n      // in the future, might want to add something else to\n      // distinguish messages from runner from message from the app,\n      // but for now, nothing would use it, so we'll keep it simple\n    };\n    self._record(obj);\n\n    self._clearSpecial();\n\n    // Process the options. By default, we want to wordwrap the message with\n    // Console.info. If we ask for raw output, then we don't want to do that. If\n    // we ask for an arrow, we want to wrap around with => as the bulletPoint.\n    Console[options.arrow ? 'arrowInfo' : 'info'](msg);\n  },\n\n  // Write a message to the terminal that will get overwritten by the\n  // next message logged. (Don't put it in the log that getLog\n  // returns.)\n  // XXX Maybe this should return an object that you have to pass to the\n  //     subsequent log call, and only such a log call will overwrite it (and an\n  //     intervening log call will cause this to stay on the screen)?\n  //     eg, a log call from the updater can interweave with the logTemporary\n  //     calls in run-all.js\n  logTemporary: function (msg) {\n    var self = this;\n\n    self._clearSpecial();\n    process.stdout.write(msg + Console.CARRIAGE_RETURN);\n    self.temporaryMessageLength = msg.length;\n  },\n\n  logRestart: function () {\n    var self = this;\n\n    if (self.consecutiveRestartMessages) {\n      // replace old message in place. this assumes that the new restart message\n      // is not shorter than the old one.\n      process.stdout.write(Console.CARRIAGE_RETURN);\n      self.messages.pop();\n      self.consecutiveRestartMessages ++;\n    } else {\n      self._clearSpecial();\n      self.consecutiveRestartMessages = 1;\n    }\n\n    var message = \"=> Meteor server restarted\";\n    if (self.consecutiveRestartMessages > 1) {\n      message += \" (x\" + self.consecutiveRestartMessages + \")\";\n    }\n    // no newline, so that we can overwrite it if we get another\n    // restart message right after this one\n    process.stdout.write(message);\n\n    self._record({\n      time: new Date,\n      message: message\n    });\n  },\n\n  logClientRestart: function () {\n    var self = this;\n\n    if (self.consecutiveClientRestartMessages) {\n      // replace old message in place. this assumes that the new restart message\n      // is not shorter than the old one.\n      process.stdout.write(Console.CARRIAGE_RETURN);\n      self.messages.pop();\n      self.consecutiveClientRestartMessages ++;\n    } else {\n      self._clearSpecial();\n      self.consecutiveClientRestartMessages = 1;\n    }\n\n    var message = \"=> Client modified -- refreshing\";\n    if (self.consecutiveClientRestartMessages > 1) {\n      message += \" (x\" + self.consecutiveClientRestartMessages + \")\";\n    }\n    // no newline, so that we can overwrite it if we get another\n    // restart message right after this one\n    process.stdout.write(message);\n\n    self._record({\n      time: new Date,\n      message: message\n    });\n  },\n\n  finish: function () {\n    var self = this;\n\n    self._clearSpecial();\n  },\n\n  clearLog: function () {\n    var self = this;\n    self.messages = [];\n  },\n\n  getLog: function () {\n    var self = this;\n    return self.messages;\n  }\n});\n\n// Create a singleton instance of RunLog. Expose its public methods on the\n// object you get with require('./run-log.js').\nvar runLogInstance = new RunLog;\n_.each(\n  ['log', 'logTemporary', 'logRestart', 'logClientRestart', 'logAppOutput',\n   'setRawLogs', 'finish', 'clearLog', 'getLog'],\n  function (method) {\n    exports[method] = _.bind(runLogInstance[method], runLogInstance);\n  });\n"]}