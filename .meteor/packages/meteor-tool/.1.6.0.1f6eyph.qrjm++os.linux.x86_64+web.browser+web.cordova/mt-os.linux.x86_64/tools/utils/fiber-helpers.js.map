{"version":3,"sources":["/tools/utils/fiber-helpers.js"],"names":["_","require","Fiber","exports","parallelEach","collection","callback","context","errors","results","Promise","all","map","args","run","apply","catch","error","push","await","length","disallowedYield","Error","disallowed","noYieldsAllowed","f","savedYield","yield","call","nodeCodeMustBeInFiber","current","nextSlot","EnvironmentVariable","defaultValue","self","slot","extend","prototype","get","_meteorDynamics","has","withValue","value","func","currentValues","saved","bindEnvironment","boundValues","clone","runWithEnvironment","savedValues","makeFulfillablePromise","resolve","reject","promise","res","rej"],"mappings":"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","file":"tools/utils/fiber-helpers.js.map","sourcesContent":["var _ = require(\"underscore\");\nvar Fiber = require(\"fibers\");\n\nexports.parallelEach = function (collection, callback, context) {\n  const errors = [];\n  context = context || null;\n\n  const results = Promise.all(_.map(collection, (...args) => {\n    async function run() {\n      return callback.apply(context, args);\n    }\n\n    return run().catch(error => {\n      // Collect the errors but do not propagate them so that we can\n      // re-throw the first error after all iterations have completed.\n      errors.push(error);\n    });\n  })).await();\n\n  if (errors.length > 0) {\n    throw errors[0];\n  }\n\n  return results;\n};\n\nfunction disallowedYield() {\n  throw new Error(\"Can't call yield in a noYieldsAllowed block!\");\n}\n// Allow testing Fiber.yield.disallowed.\ndisallowedYield.disallowed = true;\n\nexports.noYieldsAllowed = function (f, context) {\n  var savedYield = Fiber.yield;\n  Fiber.yield = disallowedYield;\n  try {\n    return f.call(context || null);\n  } finally {\n    Fiber.yield = savedYield;\n  }\n};\n\n// Borrowed from packages/meteor/dynamics_nodejs.js\n// Used by buildmessage\n\nexports.nodeCodeMustBeInFiber = function () {\n  if (!Fiber.current) {\n    throw new Error(\"Meteor code must always run within a Fiber. \" +\n                    \"Try wrapping callbacks that you pass to non-Meteor \" +\n                    \"libraries with Meteor.bindEnvironment.\");\n  }\n};\n\nvar nextSlot = 0;\nexports.EnvironmentVariable = function (defaultValue) {\n  var self = this;\n  self.slot = 'slot' + nextSlot++;\n  self.defaultValue = defaultValue;\n};\n\n_.extend(exports.EnvironmentVariable.prototype, {\n  get: function () {\n    var self = this;\n    exports.nodeCodeMustBeInFiber();\n\n    if (!Fiber.current._meteorDynamics) {\n      return self.defaultValue;\n    }\n    if (!_.has(Fiber.current._meteorDynamics, self.slot)) {\n      return self.defaultValue;\n    }\n    return Fiber.current._meteorDynamics[self.slot];\n  },\n\n  withValue: function (value, func) {\n    var self = this;\n    exports.nodeCodeMustBeInFiber();\n\n    if (!Fiber.current._meteorDynamics) {\n      Fiber.current._meteorDynamics = {};\n    }\n    var currentValues = Fiber.current._meteorDynamics;\n\n    var saved = _.has(currentValues, self.slot)\n          ? currentValues[self.slot] : self.defaultValue;\n    currentValues[self.slot] = value;\n\n    try {\n      return func();\n    } finally {\n      currentValues[self.slot] = saved;\n    }\n  }\n});\n\n// This is like Meteor.bindEnvironment.\n// Experimentally, we are NOT including onException or _this in this version.\nexports.bindEnvironment = function (func) {\n  exports.nodeCodeMustBeInFiber();\n\n  var boundValues = _.clone(Fiber.current._meteorDynamics || {});\n\n  return function (...args) {\n    var self = this;\n\n    var runWithEnvironment = function () {\n      var savedValues = Fiber.current._meteorDynamics;\n      try {\n        // Need to clone boundValues in case two fibers invoke this\n        // function at the same time\n        Fiber.current._meteorDynamics = _.clone(boundValues);\n        return func.apply(self, args);\n      } finally {\n        Fiber.current._meteorDynamics = savedValues;\n      }\n    };\n\n    if (Fiber.current) {\n      return runWithEnvironment();\n    }\n    Fiber(runWithEnvironment).run();\n  };\n};\n\n// Returns a Promise that supports .resolve(result) and .reject(error).\nexports.makeFulfillablePromise = function () {\n  var resolve, reject;\n  var promise = new Promise(function (res, rej) {\n    resolve = res;\n    reject = rej;\n  });\n  promise.resolve = resolve;\n  promise.reject = reject;\n  return promise;\n};\n"]}