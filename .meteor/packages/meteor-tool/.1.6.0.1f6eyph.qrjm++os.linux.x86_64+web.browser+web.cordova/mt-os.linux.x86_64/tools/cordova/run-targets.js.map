{"version":3,"sources":["/tools/cordova/run-targets.js"],"names":["module","export","CordovaRunTarget","iOSRunTarget","AndroidRunTarget","_","watch","require","default","v","chalk","child_process","loadIsopackage","runLog","Console","files","execFileSync","execFileAsync","title","displayName","constructor","isDevice","platform","start","cordovaProject","openXcodeProject","pathJoin","projectRoot","run","undefined","projectDir","projectFilename","readdir","filter","entry","match","printFailure","convertToOSPath","projectFilePath","info","green","url","error","message","target","tailLogs","done","checkPlatformRequirementsAndSetEnv","check_reqs_path","check_reqs","Promise","all","check_java","check_android","then","check_android_target","transform","runCommands","logLevel","verbose","filterExpressions","Log","logStream","line","logEntry","logFromAndroidLogcatLine","pipe","process","stdout","destination","priority","tag","pid","filename","lineNumber","logFromConsoleOutput","format","objFromText","metaColor","color","isDebugOutput","replace","time","Date","level","file","program","test"],"mappings":"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","file":"tools/cordova/run-targets.js.map","sourcesContent":["import _ from 'underscore';\nimport chalk from 'chalk';\nimport child_process from 'child_process';\n\nimport { loadIsopackage } from '../tool-env/isopackets.js';\nimport runLog from '../runners/run-log.js';\nimport { Console } from '../console/console.js';\nimport files from '../fs/files.js';\nimport { execFileSync, execFileAsync } from '../utils/processes.js';\n\nexport class CordovaRunTarget {\n  get title() {\n    return `app on ${this.displayName}`;\n  }\n}\n\nexport class iOSRunTarget extends CordovaRunTarget {\n  constructor(isDevice) {\n    super();\n    this.platform = 'ios';\n    this.isDevice = isDevice;\n  }\n\n  get displayName() {\n    return this.isDevice ? \"iOS Device\" : \"iOS Simulator\";\n  }\n\n  async start(cordovaProject) {\n    // ios-deploy is super buggy, so we just open Xcode and let the user\n    // start the app themselves.\n    if (this.isDevice) {\n      openXcodeProject(files.pathJoin(cordovaProject.projectRoot,\n        'platforms', 'ios'));\n    } else {\n      await cordovaProject.run(this.platform, this.isDevice, undefined);\n\n      // Bring iOS Simulator to front (it is called Simulator in Xcode 7)\n      execFileAsync('osascript', ['-e',\n`tell application \"System Events\"\n  set possibleSimulatorNames to {\"iOS Simulator\", \"Simulator\"}\n  repeat with possibleSimulatorName in possibleSimulatorNames\n    if application process possibleSimulatorName exists then\n      set frontmost of process possibleSimulatorName to true\n    end if\n  end repeat\nend tell`]);\n    }\n  }\n}\n\nfunction openXcodeProject(projectDir) {\n  const projectFilename =  files.readdir(projectDir).filter((entry) =>\n    { return entry.match(/\\.xcodeproj$/i) })[0];\n\n  if (!projectFilename) {\n    printFailure(`Couldn't find your Xcode project in directory \\\n'${files.convertToOSPath(projectDir)}'`);\n    return;\n  }\n\n  const projectFilePath = files.pathJoin(projectDir, projectFilename);\n\n  try {\n    execFileSync('open', [projectFilePath]);\n\n    Console.info();\n    Console.info(\n      chalk.green(\n        \"Your project has been opened in Xcode so that you can run your \" +\n        \"app on an iOS device. For further instructions, visit this \" +\n        \"wiki page: \") +\n      Console.url(\n        \"https://guide.meteor.com/mobile.html#running-on-ios\"\n    ));\n    Console.info();\n  } catch (error) {\n    printFailure(`Failed to open your project in Xcode:\n${error.message}`);\n  }\n\n  function printFailure(message) {\n    Console.error();\n    Console.error(message);\n    Console.error(\n      chalk.green(\"Instructions for running your app on an iOS device: \") +\n      Console.url(\"https://guide.meteor.com/mobile.html#running-on-ios\")\n    );\n    Console.error();\n  }\n}\n\nexport class AndroidRunTarget extends CordovaRunTarget {\n  constructor(isDevice) {\n    super();\n    this.platform = 'android';\n    this.isDevice = isDevice;\n  }\n\n  get displayName() {\n    return this.isDevice ? \"Android Device\" : \"Android Emulator\";\n  }\n\n  async start(cordovaProject) {\n    // XXX This only works if we have at most one device or one emulator\n    // connected. We should find a way to get the target ID from run and use\n    // it instead of -d or -e.\n    let target = this.isDevice ? \"-d\" : \"-e\";\n\n    // Clear logs\n    execFileAsync('adb', [target, 'logcat', '-c']);\n\n    await cordovaProject.run(this.platform, this.isDevice);\n\n    this.tailLogs(cordovaProject, target).done();\n  }\n\n  async checkPlatformRequirementsAndSetEnv(cordovaProject) {\n    // Cordova Android is fairly good at applying various heuristics to find\n    // suitable values for JAVA_HOME and ANDROID_HOME, and to augment the PATH\n    // with those variables.\n    // Unfortunately, this is intertwined with checking requirements, so the\n    // only way to get access to this functionality is to run check_reqs and\n    // let it modify process.env\n    var check_reqs_path = files.pathJoin(\n      cordovaProject.projectRoot, 'platforms', this.platform,\n      'cordova', 'lib', 'check_reqs');\n    check_reqs_path = files.convertToOSPath(check_reqs_path);\n    let check_reqs = require(check_reqs_path);\n    // We can't use check_reqs.run() because that will print the values of\n    // JAVA_HOME and ANDROID_HOME to stdout.\n    await Promise.all([check_reqs.check_java(),\n      check_reqs.check_android().then(check_reqs.check_android_target)]);\n  }\n\n  async tailLogs(cordovaProject, target) {\n    const { transform } = require(\"../utils/eachline.js\");\n\n    cordovaProject.runCommands(`tailing logs for ${this.displayName}`, async () => {\n      await this.checkPlatformRequirementsAndSetEnv(cordovaProject);\n\n      const logLevel = Console.verbose ? \"V\" : \"I\";\n\n      const filterExpressions = [`MeteorWebApp:${logLevel}`,\n        `CordovaLog:${logLevel}`, `chromium:${logLevel}`,\n        `SystemWebViewClient:${logLevel}`, '*:F'];\n\n      const { Log } = loadIsopackage('logging');\n\n      const logStream = transform(line => {\n        const logEntry = logFromAndroidLogcatLine(Log, line);\n        if (logEntry) {\n          return `${logEntry}\\n`;\n        }\n      });\n      logStream.pipe(process.stdout);\n\n      // Asynchronously start tailing logs to stdout\n      execFileAsync('adb', [target, 'logcat',\n        ...filterExpressions],\n        { destination: logStream });\n    });\n  }\n}\n\nfunction logFromAndroidLogcatLine(Log, line) {\n  // Ignore lines indicating beginning of logging\n  if (line.match(/^--------- beginning of /)) {\n    return null;\n  }\n\n  // Matches logcat brief format\n  // \"I/Tag(  PID): message\"\n  let match =\n    line.match(/^([A-Z])\\/([^\\(]*?)\\(\\s*(\\d+)\\): (.*)$/);\n\n  if (match) {\n    [, priority, tag, pid, message] = match;\n\n    if (tag === 'chromium') {\n      // Matches Chromium log format\n      // [INFO:CONSOLE(23)] \"Bla!\", source: http://meteor.local/app/mobileapp.js (23)\n      match = message.match(/^\\[(.*):(.*)\\((\\d+)\\)\\] (.*)$/);\n\n      if (match) {\n        [, logLevel, filename, lineNumber, message] = match;\n\n        if (filename === 'CONSOLE') {\n          match = message.match(/^\\\"(.*)\\\", source: (.*) \\((\\d+)\\)$/);\n\n          if (match) {\n            [, message, filename, lineNumber] = match;\n            return logFromConsoleOutput(Log, message, filename, lineNumber);\n          }\n        }\n      }\n    } else if (tag === 'CordovaLog') {\n      // http://meteor.local/mobileappold.js?3c198a97a802ad2c6eab52da0244245e30b964ed: Line 15 : Clicked!\n\n      match = message.match(/^(.*): Line (\\d+) : (.*)$/);\n\n      if (match) {\n        [, filename, lineNumber, message] = match;\n        return logFromConsoleOutput(Log, message, filename, lineNumber);\n      }\n    }\n  }\n\n  return Log.format(Log.objFromText(line), { metaColor: 'green', color: true });\n};\n\nfunction logFromConsoleOutput(Log, message, filename, lineNumber) {\n  if (isDebugOutput(message) && !Console.verbose) {\n    return null;\n  }\n\n  filename = filename.replace(/\\?.*$/, '');\n\n  return Log.format({\n    time: new Date,\n    level: 'info',\n    file: filename,\n    line: lineNumber,\n    message: message,\n    program: 'android'\n  }, {\n    metaColor: 'green',\n    color: true\n  });\n}\n\nfunction isDebugOutput(message) {\n  // Skip the debug output produced by Meteor components.\n  return /^METEOR CORDOVA DEBUG /.test(message) ||\n    /^HTTPD DEBUG /.test(message);\n};\n"]}