{"version":3,"sources":["/tools/isobuild/isopack.js"],"names":["Builder","module","watch","require","default","v","ISOPACKETS","makeIsopacketBuildContext","requestGarbageCollection","assert","compiler","archinfo","_","linker","buildmessage","bundler","files","colonConverter","utils","buildPluginModule","Console","Profile","rejectBadPath","p","match","Error","nextBuildId","Unibuild","isopack","options","self","pkg","kind","arch","uses","implies","watchSet","WatchSet","id","name","declaredExports","resources","nodeModulesDirectories","some","nmd","nodeModulesPath","local","Isopack","metadata","version","isTest","debugOnly","prodOnly","testOnly","unibuilds","plugins","cordovaDependencies","isobuildFeatures","pluginWatchSet","_pluginsInitialized","sourceProcessors","linter","minifier","includeTool","toolsOnDisk","pluginProviderPackageMap","pluginCacheDir","lintingMessages","knownFormats","convertOneStepForward","data","fromFormat","convertedData","clone","builds","convertOneStepBackward","format","convertIsopackFormat","toFormat","fromPos","indexOf","toPos","step","readMetadataFromDirectory","isopackDirectory","originalVersion","isopackJsonPath","pathJoin","unipackageJsonPath","exists","isopackJson","JSON","parse","readFile","exports","OldIsopackFormatError","stringify","extend","prototype","initEmpty","initFromOptions","npmDiscards","addUnibuild","push","setPluginProviderPackageMap","getSourceFilesUnderSourceRoot","sourceRoot","sourceFiles","anySourceFiles","addSourceFilesFromWatchSet","each","hash","filename","relativePath","pathRelative","substr","pathSep","u","keys","architectures","archSet","unibuild","_toolArchitectures","plugin","plug","arches","sort","any","a","without","buildArchitectures","join","platformSpecific","tarballName","convert","toolArches","pluck","host","uniq","getUnibuildAtArch","chosenArch","mostSpecificMatch","error","secondary","findWhere","_checkPluginsInitialized","ensurePluginsInitialized","assertInJob","SourceProcessorSet","displayName","hardcodeJs","singlePackage","allowConflicts","pluginsByArch","enterJob","title","Plugin","_makePluginApi","load","sourceProcessorSet","allSourceProcessors","sourceProcessor","instantiatePlugin","registerSourceHandler","extension","handler","addLegacyHandler","packageDisplayName","isTemplate","archMatching","_registerSourceProcessor","extensions","filenames","factory","methodName","featurePackage","featureEnabled","hasExtensions","Array","length","hasFilenames","useMyCaller","e","endsWith","f","sp","SourceProcessor","factoryFunction","addSourceProcessor","registerCompiler","registerLinter","registerMinifier","badUsedExtension","find","ext","contains","undefined","nudge","convertToOSPath","convertToStandardPath","path","normalize","pathNormalize","relative","resolve","pathResolve","dirname","pathDirname","basename","pathBasename","extname","pathExtname","sep","fs","fsFixPath","initFromPath","dir","firstIsopack","_loadUnibuildsFromPath","realpath","mainJson","has","unibuildWatchSets","isopackBuildInfoJson","unibuildDependencies","watchSetJSON","unibuildTag","fromJSON","pluginDependencies","summary","pluginMeta","readJsImage","pluginsBuilt","unibuildMeta","alreadyHaveUnibuild","unibuildJson","unibuildBasePath","unibuildHasPrelink","resource","file","readBufferWithLengthAndOffset","offset","type","prelinkResource","servePath","sha1","usesDefaultSourceProcessor","legacyPrelink","packageVariables","sourceMap","fileOptions","pv","export","forEach","use","weak","isIsobuildFeaturePackage","package","rebuildBinaries","matches","NodeModulesDirectory","readDirsFromJSON","node_modules","packageName","tools","toolMeta","rootDir","hasCordovaUnibuild","canWriteLegacyBuilds","isResourceSafeForLegacyBuilds","every","saveToPath","outputDir","includePreCompilerPluginIsopackVersions","includeIsopackBuildInfo","isopackCache","outputPath","builder","isEmpty","writeLegacyBuilds","builtBy","BUILT_BY","toJSON","includeCordovaUnibuild","reserve","npmDirsToCopy","Object","create","write","Buffer","from","unibuildInfos","baseUnibuildName","unibuildDir","generateFilename","directory","unibuildJsonFile","jsResourcesForLegacyPrelink","bundlePath","sourcePath","getPreferredBundlePath","preferredPaths","map","constraint","unordered","usesModules","concat","head","body","lazy","parts","generatedFilename","writeToGeneratedFilename","_getServePath","bare","writeJson","copyDirectory","to","symlink","pluginDir","pluginBuild","enter","pluginEntry","controlFile","toolsJson","_writeTool","mainLegacyJson","unibuildInfo","legacyFilename","legacyDir","newResources","prelinkFile","prelinkData","packageVariableNames","symbol","results","prelink","inputFiles","combinedServePath","source","assignedVariables","acceptedByBuffer","isString","isNumber","isArray","complete","abort","pathsToCopy","runGitInCheckout","filter","split","transpileRegexes","pathsToTranspile","pathsToCopyStraight","shouldTranspile","regex","toolPath","babel","fullPath","getCurrentToolsDir","inputFileContents","replace","babelOptions","getDefaultOptions","nodeMajorVersion","parseInt","process","versions","node","sourceFileName","sourceMapTarget","transpiled","compile","sourceMapUrlComment","code","gitSha","specificFiles","devBundleIgnore","ignoreFiles","getDevBundle","ignore","isopacketBuildContext","messages","capture","packages","isopacketName","buildLocalPackages","jobHasMessages","image","buildJsImage","packageMap","hasMessages","formatMessages","getMergedWatchSet","merge","getClientWatchSet","test","getServerWatchSet","getStrongOrderedUsedAndImpliedPackages","processUse","featurePackageName","pathInPackage","serveRoot","toString"],"mappings":"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","file":"tools/isobuild/isopack.js.map","sourcesContent":["var assert = require('assert');\nvar compiler = require('./compiler.js');\nvar archinfo = require('../utils/archinfo.js');\nvar _ = require('underscore');\nvar linker = require('./linker.js');\nvar buildmessage = require('../utils/buildmessage.js');\nimport Builder from './builder.js';\nvar bundler = require('./bundler.js');\nvar watch = require('../fs/watch.js');\nvar files = require('../fs/files.js');\nimport {\n  ISOPACKETS,\n  makeIsopacketBuildContext,\n} from '../tool-env/isopackets.js';\nvar colonConverter = require('../utils/colon-converter.js');\nvar utils = require('../utils/utils.js');\nvar buildPluginModule = require('./build-plugin.js');\nvar Console = require('../console/console.js').Console;\nvar Profile = require('../tool-env/profile.js').Profile;\nimport { requestGarbageCollection } from \"../utils/gc.js\";\n\nvar rejectBadPath = function (p) {\n  if (p.match(/\\.\\./)) {\n    throw new Error(\"bad path: \" + p);\n  }\n};\n\n///////////////////////////////////////////////////////////////////////////////\n// Unibuild\n///////////////////////////////////////////////////////////////////////////////\n\n// Options:\n// - kind [required] (main/plugin/app)\n// - arch [required]\n// - uses\n// - implies\n// - watchSet\n// - nodeModulesDirectories\n// - declaredExports\n// - resources\n\nvar nextBuildId = 1;\nvar Unibuild = function (isopack, options) {\n  var self = this;\n  options = options || {};\n  self.pkg = isopack;\n\n  self.kind = options.kind;\n  self.arch = options.arch;\n\n  self.uses = options.uses;\n  self.implies = options.implies || [];\n\n  // This WatchSet will end up having the watch items from the\n  // SourceArch (such as package.js or .meteor/packages), plus all of\n  // the actual source files for the unibuild (including items that we\n  // looked at to find the source files, such as directories we\n  // scanned).\n  self.watchSet = options.watchSet || new watch.WatchSet();\n\n  // Each Unibuild is given a unique id when it's loaded (it is\n  // not saved to disk). This is just a convenience to make it easier\n  // to keep track of Unibuilds in a map; it's used by bundler\n  // and compiler. We put some human readable info in here too to make\n  // debugging easier.\n  self.id = self.pkg.name + \".\" + self.kind + \"@\" + self.arch + \"#\" +\n    (nextBuildId ++);\n\n  // 'declaredExports' are the variables which are exported from this package.\n  // A list of objects with keys 'name' (required) and 'testOnly' (boolean,\n  // defaults to false).\n  self.declaredExports = options.declaredExports;\n\n  // All of the data provided for eventual inclusion in the bundle,\n  // other than JavaScript that still needs to be fed through the\n  // final link stage. A list of objects with these keys:\n  //\n  // type: \"source\", \"head\", \"body\", \"asset\". (resources produced by\n  // legacy source handlers can also be \"js\" or \"css\".\n  //\n  // data: The contents of this resource, as a Buffer. For example,\n  // for \"head\", the data to insert in <head>; for \"js\", the\n  // JavaScript source code (which may be subject to further\n  // processing such as minification); for \"asset\", the contents of a\n  // static resource such as an image.\n  //\n  // servePath: The (absolute) path at which the resource would prefer\n  // to be served. Interpretation varies by type. For example, always\n  // honored for \"asset\", ignored for \"head\" and \"body\", sometimes\n  // honored for CSS but ignored if we are concatenating.\n  //\n  // sourceMap: Allowed only for \"js\". If present, a string.\n  //\n  // fileOptions: for \"source\", the options passed to `api.addFiles`.\n  // plugin-specific.\n  //\n  // extension: for \"source\", the file extension that this matched\n  // against at build time. null if matched against a specific filename.\n  self.resources = options.resources;\n\n  // Map from absolute paths of node_modules directories to\n  // NodeModulesDirectory objects.\n  self.nodeModulesDirectories = options.nodeModulesDirectories;\n\n  // Provided for backwards compatibility; please use\n  // unibuild.nodeModulesDirectories instead!\n  _.some(self.nodeModulesDirectories, (nmd, nodeModulesPath) => {\n    if (! nmd.local) {\n      self.nodeModulesPath = nodeModulesPath;\n      return true;\n    }\n  });\n};\n\n///////////////////////////////////////////////////////////////////////////////\n// Isopack\n///////////////////////////////////////////////////////////////////////////////\n\n// Meteor has a packaging system called \"Isobuild\". Isobuild knows how to\n// compile the same JavaScript code-base to different architectures: browser,\n// node.js-like server environment (could be Rhino or other) or a webview in a\n// Cordova mobile app.\n//\n// Each package used by Isobuild forms an Isopack. Isopack is a package format\n// containing source code for each architecture it can be ran on.\n// Each separate part built for a separate architecture is called \"Unibuild\".\n//\n// There are multiple reasons why we can't call it just \"build\" and historically\n// the name \"Unibuild\" has been associated with parts of Isopacks. We also can't\n// call it \"Isobuild\" because this is the brand-name of the whole\n// build/packaging system.\nvar Isopack = function () {\n  var self = this;\n\n  // These have the same meaning as in PackageSource.\n  self.name = null;\n  self.metadata = {};\n  self.version = null;\n  self.isTest = false;\n  self.debugOnly = false;\n  self.prodOnly = false;\n  self.testOnly = false;\n\n  // Unibuilds, an array of class Unibuild.\n  self.unibuilds = [];\n\n  // Plugins in this package. Map from plugin name to {arch -> JsImage}.\n  // Plugins are package-supplied classes and functions that can change the\n  // build process: introduce a new source processor (compiler, minifier,\n  // linter)\n  self.plugins = {};\n\n  self.cordovaDependencies = {};\n\n  // isobuild:* pseudo-packages which this package depends on.\n  self.isobuildFeatures = [];\n\n  // -- Information for up-to-date checks --\n  // Data in this section is only set if the Isopack was directly created by\n  // compiler.compile or read from a package compiled by IsopackCache (with its\n  // isopack-buildinfo.json file). They are not set for Isopacks read from\n  // the tropohouse.\n\n  // XXX this is likely to change once we have build versions\n  //\n  // A WatchSet for the full transitive dependencies for all plugins in this\n  // package, as well as this package's package.js. If any of these dependencies\n  // change, our plugins need to be rebuilt... but also, any package that\n  // directly uses this package needs to be rebuilt in case the change to\n  // plugins affected compilation.\n  self.pluginWatchSet = new watch.WatchSet();\n\n  // -- Loaded plugin state --\n\n  // True if plugins have been initialized (if ensurePluginsInitialized has\n  // been called)\n  self._pluginsInitialized = false;\n\n  // The SourceProcessors registered by plugins defined by this package.  Each\n  // value is a SourceProcessorSet. sourceProcessors.compiler includes the\n  // legacy source handlers as well.\n  // Valid when self._pluginsInitialized is true.\n  self.sourceProcessors = {\n    compiler: null,\n    linter: null,\n    minifier: null\n  };\n\n  // See description in PackageSource. If this is set, then we include a copy of\n  // our own source, in addition to any other tools that were originally in the\n  // isopack.\n  self.includeTool = false;\n\n  // This is tools to copy from trees on disk. This is used by the\n  // isopack-merge code in tropohouse.\n  self.toolsOnDisk = [];\n\n  // A map of package dependencies that can provide a plugin for this isopack.\n  // In practice, it is every direct dependency and implied packages.\n  self.pluginProviderPackageMap = null;\n\n  // A directory on disk that plugins can use for caching. Should be created\n  // by the code that initializes the Isopack. If not provided, plugins don't\n  // get a disk cache.\n  self.pluginCacheDir = null;\n\n  // An in-memory only buildmessage.MessageSet object that is printed by the\n  // build tool when the app is linted. Is also printed when a package\n  // represented by Isopack is published.\n  self.lintingMessages = null;\n};\n\nIsopack.knownFormats = [\"unipackage-pre2\", \"isopack-1\", \"isopack-2\"];\n\n// These functions are designed to convert isopack metadata between\n// versions. They were designed to convert between unipackage-pre2 and\n// isopack-1. The differences between these formats are essentially syntactical,\n// not semantic, and occur entirely in the isopack.json file, not in the\n// individual unibuild json files. These functions are written assuming those\n// constraints, and were not actually useful in the isopack-1/isopack-2\n// transition,where most of the changes are in the unibuild level, and there's\n// actual semantic changes involved. So they are not actually used as much as\n// they were before.\nIsopack.convertOneStepForward = function (data, fromFormat) {\n  var convertedData = _.clone(data);\n  // XXX COMPAT WITH 0.9.3\n  if (fromFormat === \"unipackage-pre2\") {\n    convertedData.builds = convertedData.unibuilds;\n    delete convertedData.unibuilds;\n    return convertedData;\n  }\n  if (fromFormat === \"isopack-1\") {\n    // For now, there's no difference in this direction at the isopack level.\n    return convertedData;\n  }\n};\nIsopack.convertOneStepBackward = function (data, fromFormat) {\n  var convertedData = _.clone(data);\n  if (fromFormat === \"isopack-1\") {\n    convertedData.unibuilds = convertedData.builds;\n    convertedData.format = \"unipackage-pre2\";\n    delete convertedData.builds;\n    return convertedData;\n  }\n  if (fromFormat === \"isopack-2\") {\n    // The conversion from isopack-2 requires converting the nested\n    // unibuild data as well.  This shouldn't happen.\n    throw Error(\"Can't automatically convert backwards from isopack-2\");\n  }\n};\nIsopack.convertIsopackFormat = Profile(\n  \"Isopack.convertIsopackFormat\", function (data, fromFormat, toFormat) {\n  var fromPos = _.indexOf(Isopack.knownFormats, fromFormat);\n  var toPos = _.indexOf(Isopack.knownFormats, toFormat);\n  var step = fromPos < toPos ? 1 : -1;\n\n  if (fromPos === -1) {\n    throw new Error(\"Can't convert from unknown Isopack format: \" + fromFormat);\n  }\n  if (toPos === -1) {\n    throw new Error(\"Can't convert to unknown Isopack format: \" + toFormat);\n  }\n\n  while (fromPos !== toPos) {\n    if (step > 0) {\n      data = Isopack.convertOneStepForward(data, fromFormat);\n    } else {\n      data = Isopack.convertOneStepBackward(data, fromFormat);\n    }\n\n    fromPos += step;\n    fromFormat = Isopack.knownFormats[fromPos];\n  }\n\n  return data;\n});\n\n// Read the correct file from isopackDirectory and convert to current format\n// of the isopack metadata. Returns null if there is no package here.\nIsopack.readMetadataFromDirectory =\n  Profile(\"Isopack.readMetadataFromDirectory\", function (isopackDirectory) {\n  var metadata = null;\n  let originalVersion = null;\n\n  // deal with different versions of \"isopack.json\", backwards compatible\n  var isopackJsonPath = files.pathJoin(isopackDirectory, \"isopack.json\");\n  var unipackageJsonPath = files.pathJoin(isopackDirectory, \"unipackage.json\");\n\n  if (files.exists(isopackJsonPath)) {\n    var isopackJson = JSON.parse(files.readFile(isopackJsonPath));\n\n    if (isopackJson['isopack-2']) {\n      metadata = isopackJson['isopack-2'];\n      originalVersion = 'isopack-2';\n    } else if (isopackJson['isopack-1']) {\n      metadata = Isopack.convertIsopackFormat(\n        isopackJson['isopack-1'], 'isopack-1', 'isopack-2');\n      originalVersion = 'isopack-1';\n    } else {\n      // This file is from the future and no longer supports this version\n      throw new Error(\"Could not find isopack data supported any supported format (isopack-1 or isopack-2).\\n\" +\n        \"This isopack was likely built with a much newer version of Meteor.\");\n    }\n  } else if (files.exists(unipackageJsonPath)) {\n    // super old version with different file name\n    // XXX COMPAT WITH 0.9.3\n    if (files.exists(unipackageJsonPath)) {\n      metadata = JSON.parse(files.readFile(unipackageJsonPath));\n\n      metadata = Isopack.convertIsopackFormat(metadata,\n        \"unipackage-pre2\", \"isopack-2\");\n      originalVersion = 'unipackage-pre2';\n    }\n\n    if (metadata.format !== \"unipackage-pre2\") {\n      // We don't support pre-0.9.0 isopacks, but we do know enough to delete\n      // them if we find them in an isopack cache somehow (rather than crash).\n      if (metadata.format === \"unipackage-pre1\") {\n        throw new exports.OldIsopackFormatError();\n      }\n\n      throw new Error(\"Unsupported isopack format: \" +\n                      JSON.stringify(metadata.format));\n    }\n  }\n\n  return {metadata, originalVersion};\n});\n\n_.extend(Isopack.prototype, {\n  // Make a dummy (empty) package that contains nothing of interest.\n  // XXX used?\n  initEmpty: function (name) {\n    var self = this;\n    self.name = name;\n  },\n\n  // This is primarily intended to be used by the compiler. After\n  // calling this, call addUnibuild to add the unibuilds.\n  initFromOptions: function (options) {\n    var self = this;\n    self.name = options.name;\n    self.metadata = options.metadata;\n    self.version = options.version;\n    self.isTest = options.isTest;\n    self.plugins = options.plugins;\n    self.cordovaDependencies = options.cordovaDependencies;\n    self.pluginWatchSet = options.pluginWatchSet;\n    self.npmDiscards = options.npmDiscards;\n    self.includeTool = options.includeTool;\n    self.debugOnly = options.debugOnly;\n    self.prodOnly = options.prodOnly;\n    self.testOnly = options.testOnly;\n    self.pluginCacheDir = options.pluginCacheDir || null;\n    self.isobuildFeatures = options.isobuildFeatures;\n  },\n\n  // Programmatically add a unibuild to this Isopack. Should only be\n  // called as part of building up a new Isopack using\n  // initFromOptions. 'options' are the options to the Unibuild\n  // constructor.\n  addUnibuild: function (options) {\n    var self = this;\n    self.unibuilds.push(new Unibuild(self, options));\n  },\n\n  setPluginProviderPackageMap: function (pluginProviderPackageMap) {\n    var self = this;\n    self.pluginProviderPackageMap = pluginProviderPackageMap;\n  },\n\n  getSourceFilesUnderSourceRoot: Profile(\n    \"Isopack#getSourceFilesUnderSourceRoot\", function (sourceRoot) {\n    var self = this;\n    var sourceFiles = {};\n    var anySourceFiles = false;\n    var addSourceFilesFromWatchSet = function (watchSet) {\n      _.each(watchSet.files, function (hash, filename) {\n        if (! hash) {\n          // If a file has a falsy hash, that means the file does/should\n          // not exist.\n          return;\n        }\n\n        anySourceFiles = true;\n        var relativePath = files.pathRelative(sourceRoot, filename);\n        // We only want files that are actually under sourceRoot.\n        if (relativePath.substr(0, 3) === '..' + files.pathSep) {\n          return;\n        }\n        sourceFiles[relativePath] = true;\n      });\n    };\n    addSourceFilesFromWatchSet(self.pluginWatchSet);\n    _.each(self.unibuilds, function (u) {\n      addSourceFilesFromWatchSet(u.watchSet);\n    });\n\n    // Were we actually built from source or loaded from an IsopackCache? If so\n    // then there should be at least one source file in some WatchSet. If not,\n    // return null.\n    if (! anySourceFiles) {\n      return null;\n    }\n    return _.keys(sourceFiles);\n  }),\n\n  // An sorted array of all the architectures included in this package.\n  architectures: Profile(\"Isopack#architectures\", function () {\n    var self = this;\n    var archSet = {};\n    _.each(self.unibuilds, function (unibuild) {\n      archSet[unibuild.arch] = true;\n    });\n    _.each(self._toolArchitectures(), function (arch) {\n      archSet[arch] = true;\n    });\n    _.each(self.plugins, function (plugin, name) {\n      _.each(plugin, function (plug, arch) {\n        archSet[arch] = true;\n      });\n    });\n    var arches = _.keys(archSet).sort();\n    // Ensure that our buildArchitectures string does not look like\n    //    web+os+os.osx.x86_64\n    // This would happen if there is an 'os' unibuild but a platform-specific\n    // tool (eg, in meteor-tool).  This would confuse catalog.getBuildsForArches\n    // into thinking that it would work for Linux, since the 'os' means\n    // 'works on any Node server'.\n    if (_.any(arches, function (a) { return a.match(/^os\\./); })) {\n      arches = _.without(arches, 'os');\n    }\n    return arches;\n  }),\n\n  // A sorted plus-separated string of all the architectures included in this\n  // package.\n  buildArchitectures: function () {\n    var self = this;\n    return self.architectures().join('+');\n  },\n\n  // Returns true if we think that this isopack is platform specific (contains\n  // binary builds)\n  platformSpecific: function () {\n    var self = this;\n    return _.any(self.architectures(), function (arch) {\n      return arch.match(/^os\\./);\n    });\n  },\n\n  tarballName: function () {\n    var self = this;\n    return colonConverter.convert(self.name) + '-' + self.version;\n  },\n\n  _toolArchitectures: function () {\n    var self = this;\n    var toolArches = _.pluck(self.toolsOnDisk, 'arch');\n    self.includeTool && toolArches.push(archinfo.host());\n    return _.uniq(toolArches).sort();\n  },\n\n  // Return the unibuild of the package to use for a given target architecture\n  // (eg, 'os.linux.x86_64' or 'web'), or throw an exception if that\n  // packages can't be loaded under these circumstances.\n  getUnibuildAtArch: Profile(\"Isopack#getUnibuildAtArch\", function (arch) {\n    var self = this;\n\n    let chosenArch = archinfo.mostSpecificMatch(\n      arch, _.pluck(self.unibuilds, 'arch'));\n    if (! chosenArch && arch.match(/^os\\./)) {\n      // Special-case: we're looking for a specific server platform and\n      // it's not available. (eg, we're deploying from a Mac to Linux and\n      // are processing a local package with binary npm deps).  Search\n      // again for the host version, which might find the Mac version.\n      chosenArch =\n        archinfo.mostSpecificMatch(archinfo.host(), _.pluck(self.unibuilds, 'arch'));\n    }\n    if (! chosenArch) {\n      buildmessage.error(\n        (self.name || \"this app\") +\n          \" is not compatible with architecture '\" + arch + \"'\",\n        { secondary: true });\n      // recover by returning by no unibuilds\n      return null;\n    }\n    return _.findWhere(self.unibuilds, { arch: chosenArch });\n  }),\n\n  _checkPluginsInitialized: function () {\n    var self = this;\n    if (self._pluginsInitialized) {\n      return;\n    }\n    throw Error(\"plugins not yet initialized?\");\n  },\n\n  // If this package has plugins, initialize them (run the startup\n  // code in them so that they register their extensions). Idempotent.\n  ensurePluginsInitialized: Profile(\"Isopack#ensurePluginsInitialized\", function () {\n    var self = this;\n\n    buildmessage.assertInJob();\n\n    if (self._pluginsInitialized) {\n      return;\n    }\n\n    self.sourceProcessors.compiler = new buildPluginModule.SourceProcessorSet(\n      self.displayName(), { hardcodeJs: true, singlePackage: true });\n    self.sourceProcessors.linter = new buildPluginModule.SourceProcessorSet(\n      self.displayName(), { singlePackage: true, allowConflicts: true });\n    self.sourceProcessors.minifier = new buildPluginModule.SourceProcessorSet(\n      self.displayName(), { singlePackage: true });\n\n    _.each(self.plugins, function (pluginsByArch, name) {\n      var arch = archinfo.mostSpecificMatch(\n        archinfo.host(), _.keys(pluginsByArch));\n      if (! arch) {\n        buildmessage.error(\"package `\" + name + \"` is built for incompatible \" +\n                           \"architecture\");\n        // Recover by ignoring plugin\n        // XXX does this recovery work?\n        return;\n      }\n\n      var plugin = pluginsByArch[arch];\n      buildmessage.enterJob({\n        title: \"loading plugin `\" + name +\n          \"` from package `\" + self.name + \"`\"\n        // don't necessarily have rootPath anymore\n        // (XXX we do, if the isopack was locally built, which is\n        // the important case for debugging. it'd be nice to get this\n        // case right.)\n      }, function () {\n        // Make a new Plugin API object for this plugin.\n        var Plugin = self._makePluginApi();\n        plugin.load({ Plugin: Plugin, Profile: Profile });\n      });\n    });\n\n    // Instantiate each of the registered batch plugins.  Note that we don't\n    // do this directly in the registerCompiler (etc) call, because we want\n    // to allow people to do something like:\n    //   Plugin.registerCompiler({...}, function () { return new C; });\n    //   var C = function () {...}\n    // and so we want to wait for C to be defined.\n    _.each(self.sourceProcessors, (sourceProcessorSet) => {\n      _.each(sourceProcessorSet.allSourceProcessors, (sourceProcessor) => {\n        sourceProcessor.instantiatePlugin();\n      });\n    });\n\n    self._pluginsInitialized = true;\n  }),\n\n  _makePluginApi: function () {\n    var isopack = this;\n\n    /**\n     * @global\n     * @namespace Plugin\n     * @summary The namespace that is exposed inside build plugin files.\n     */\n    var Plugin = {\n      // 'extension' is a file extension without the separation dot\n      // (eg 'js', 'coffee', 'coffee.md')\n      //\n      // 'options' can be omitted. The only known option is 'isTemplate', which\n      // is a bit of a hack meaning \"in an app, these files should be loaded\n      // before non-templates\".\n      //\n      // 'handler' is a function that takes a single argument, a\n      // CompileStep (#CompileStep)\n\n      /**\n       * @summary Inside a build plugin source file specified in\n       * [Package.registerBuildPlugin](#Package-registerBuildPlugin),\n       * add a handler to compile files with a certain file extension.\n       * @param  {String} fileExtension The file extension that this plugin\n       * should handle, without the first dot.\n       * Examples: `\"coffee\"`, `\"coffee.md\"`.\n       * @param  {Function} handler  A function that takes one argument,\n       * a CompileStep object.\n       *\n       * Documentation for CompileStep is available [on the GitHub Wiki](https://github.com/meteor/meteor/wiki/CompileStep-API-for-Build-Plugin-Source-Handlers).\n       * @memberOf Plugin\n       * @locus Build Plugin\n       * @deprecated since 1.2\n       * XXX COMPAT WITH 1.1\n       */\n      registerSourceHandler: function (extension, options, handler) {\n        if (!handler) {\n          handler = options;\n          options = {};\n        }\n\n        // The popular package mquandalle:bower has a call to\n        // `registerSourceHandler('json', null)` for some reason, to\n        // work around some behavior of Meteor believed to be a bug. We\n        // think that new features of registerCompiler like being able\n        // to register for filenames will allow them to drop that line,\n        // but in the meantime we might as well not choke on it. (The\n        // old implementation coincidentally didn't choke.)\n        if (!handler) {\n          handler = function () {};\n        }\n\n        isopack.sourceProcessors.compiler.addLegacyHandler({\n          extension,\n          handler,\n          packageDisplayName: isopack.displayName(),\n          isTemplate: !!options.isTemplate,\n          archMatching: options.archMatching\n        });\n      },\n\n      _registerSourceProcessor: function (\n        {extensions, filenames, archMatching, isTemplate},\n        factory,\n        {sourceProcessorSet, methodName, featurePackage}) {\n        if (!isopack.featureEnabled(featurePackage)) {\n          // This error is OK because we only define 1.0.0 for each of these\n          // feature packages (in compiler.KNOWN_ISOBUILD_FEATURE_PACKAGES).\n          buildmessage.error(\n            `your package must \\`api.use('${ featurePackage }@1.0.0')\\` in ` +\n              `order for its plugins to call Plugin.${ methodName }`);\n          return;\n        }\n\n        const hasExtensions = (extensions &&\n                               extensions instanceof Array &&\n                               extensions.length > 0);\n        const hasFilenames = (filenames &&\n                              filenames instanceof Array &&\n                              filenames.length > 0);\n        if (! (hasExtensions || hasFilenames)) {\n          buildmessage.error(\"Plugin.\" + methodName + \" must specify a \" +\n                             \"non-empty array of extensions or filenames\",\n                             { useMyCaller: 3 });\n          // recover by ignoring\n          return;\n        }\n\n        // Don't let extensions or filenames try to look for directories (in the\n        // way that WatchSet expresses them).\n        if (extensions && extensions.some(e => e.endsWith('/'))) {\n          buildmessage.error(\n            `Plugin.${methodName}: extensions may not end in /`);\n          // recover by ignoring\n          return;\n        }\n        if (filenames && filenames.some(f => f.endsWith('/'))) {\n          buildmessage.error(\n            `Plugin.${methodName}: filenames may not end in /`);\n          // recover by ignoring\n          return;\n        }\n\n        if (typeof factory !== 'function') {\n          buildmessage.error(methodName + \" call must \"\n                             + \"specify a factory function\",\n                             { useMyCaller: 3 });\n          // recover by ignoring\n          return;\n        }\n\n        const sp = new buildPluginModule.SourceProcessor({\n          isopack: isopack,\n          extensions: extensions,\n          filenames: filenames,\n          archMatching: archMatching,\n          isTemplate: isTemplate,\n          factoryFunction: factory,\n          methodName: methodName\n        });\n        // This logs a buildmessage on conflicts.\n        sourceProcessorSet.addSourceProcessor(sp);\n      },\n\n      // Compilers are part of the Batch Plugins API.\n      //\n      // A compiler plugin is provided by packages to participate in\n      // the build process. A compiler can register file extensions and\n      // filenames it handles and the build tool will call the compiler's\n      // `processFilesForTarget` method once for each target (eg, the server\n      // or client program) with all of the files in the target.\n      //\n      // Compilers are run on application bundling (in bundle.js).\n      // This is different from the legacy registerSourceHandler API,\n      // which runs on a single file at a time when a *package* is built.\n      // Published Isopack packages contain the original sources of\n      // files handled by registerCompiler, not the generated output,\n      // so compilers can be involved in the very end, when the app is bundled\n      // (not in package publish time).  (Note that this requires a new\n      // Isopack format, 'isopack-2'; versions of packages published with new\n      // compilers cannot be used with previous releases of Meteor, but\n      // Version Solver knows this and will select an older compatible\n      // version if possible.\n      //\n      // Unlike the legacy API called \"source handlers\" (deprecated in\n      // Meteor 1.2), compiler plugins can handle all files for the target,\n      // making independent decisions about caching and dependencies resolution.\n      //\n      // The factory function must return an instance of a compiler.\n      //\n      // Note: It's important to ensure that all plugins that want to call\n      // plugin compiler use the isobuild:compiler-plugin fake package, so that\n      // Version Solver will not let you use registerCompiler plugins with old\n      // versions of the tool.\n\n      /**\n       * @summary Inside a build plugin source file specified in\n       * [Package.registerBuildPlugin](#Package-registerBuildPlugin),\n       * add a compiler that will handle files with certain extensions or\n       * filenames.\n       * @param {Object} options\n       * @param {String[]} options.extensions The file extensions that this\n       * plugin should handle, without the first dot.\n       * Examples: `[\"coffee\", \"coffee.md\"]`.\n       * @param {String[]} options.filenames The list of filenames\n       * that this plugin should handle. Examples: `[\"config.json\"]`.\n       * @param {Function} factory A function that returns an instance\n       * of a compiler class.\n       *\n       * More detailed documentation for build plugins is available [on the GitHub Wiki](https://docs.meteor.com/api/packagejs.html#build-plugin-api).\n       * @memberOf Plugin\n       * @locus Build Plugin\n       */\n      registerCompiler: function (options, factory) {\n        Plugin._registerSourceProcessor(options || {}, factory, {\n          sourceProcessorSet: isopack.sourceProcessors.compiler,\n          methodName: \"registerCompiler\",\n          featurePackage: \"isobuild:compiler-plugin\"\n        });\n      },\n\n      // Linters are part of the Batch Plugin API.\n      //\n      // A linter plugin provides a Linter instance. The linter is\n      // given a batch of source files for the target according to\n      // linter's declared file extensions and filenames (e.g.: '*.js',\n      // '.jshintrc').\n      //\n      // Linters don't output any files. They can only raise an error\n      // message on one of the source files to force the build tool to\n      // print a linting message.\n      //\n      // The factory function must return an instance of the linter.\n      // The linter must have the `processFilesForPackage` method that\n      // has two arguments:\n      // - inputFiles - LinterFile - sources instances\n      // - options - Object\n      //   - globals - a list of strings - global variables that can be\n      //     used in the target's scope as they are dependencies of the\n      //     package or the app. e.g.: \"Minimongo\" or \"Webapp\".\n      //\n      // Unlike compilers and minifiers, linters run on one package\n      // at a time.  Linters are run by `meteor run`, `meteor publish`,\n      // and `meteor lint`.\n\n      /**\n       * @summary Inside a build plugin source file specified in\n       * [Package.registerBuildPlugin](#Package-registerBuildPlugin),\n       * add a linter that will handle files with certain extensions or\n       * filenames.\n       * @param {Object} options\n       * @param {String[]} options.extensions The file extensions that this\n       * plugin should handle, without the first dot.\n       * Examples: `[\"js\", \"es6\", \"jsx\"]`.\n       * @param {Function} factory A function that returns an instance\n       * of a linter class.\n       *\n       * More detailed documentation for build plugins is available [on the GitHub Wiki](https://docs.meteor.com/api/packagejs.html#build-plugin-api).\n       * @memberOf Plugin\n       * @locus Build Plugin\n       */\n      registerLinter: function (options, factory) {\n        Plugin._registerSourceProcessor(options || {}, factory, {\n          sourceProcessorSet: isopack.sourceProcessors.linter,\n          methodName: \"registerLinter\",\n          featurePackage: \"isobuild:linter-plugin\"\n        });\n      },\n\n      // Minifiers are part of the Batch Plugin API.\n      //\n      // The minifiers are applied in the very end of the bundling\n      // process, after the linters and compilers. Unlike linters and\n      // compilers, minifiers are given the output of compilers and not\n      // the source files the application developer supplied.\n      //\n      // The minifier plugins can fill into 2 types of minifiers: CSS or JS.\n      // When the minifier is added to an app, it is used during \"bundling\" to\n      // compress the app code and each package's code separately.\n      // Only minifier packages directly used by an app (or implied by a package\n      // directly used by the app) are active: using a minifer's package in\n      // another package does nothing.\n      //\n      // So far, the minifiers are only run on client targets such as\n      // web.browser and web.cordova.\n      //\n      // The factory function must return an instance of a\n      // minifier. The method `processFilesForBundle` is passed a list of\n      // files, possibly a linked file per target (for JavaScript files).\n      //\n      // - files - processed files to minify\n      // - options - Object\n      //   - minifyMode - string - 'development' or 'production', based\n      //     on the bundling mode\n\n      /**\n       * @summary Inside a build plugin source file specified in\n       * [Package.registerBuildPlugin](#Package-registerBuildPlugin),\n       * add a linter that will handle files with certain extensions or\n       * filenames.\n       * @param {Object} options\n       * @param {String[]} options.extensions The file extensions that this\n       * plugin should handle, without the first dot. Can only be \"js\" or \"css\".\n       * Examples: `[\"js\", \"css\"]`.\n       * @param {String[]} options.filenames The list of filenames\n       * that this plugin should handle. Examples: `[\"config.json\"]`.\n       * @param {Function} factory A function that returns an instance\n       * of a minifier class.\n       *\n       * More detailed documentation for build plugins is available [on the GitHub Wiki](https://docs.meteor.com/api/packagejs.html#build-plugin-api).\n       * @memberOf Plugin\n       * @locus Build Plugin\n       */\n      registerMinifier: function (options, factory) {\n        var badUsedExtension = _.find(options.extensions, function (ext) {\n          return ! _.contains(['js', 'css'], ext);\n        });\n\n        if (badUsedExtension !== undefined) {\n          buildmessage.error(badUsedExtension + ': Minifiers are only allowed to register \"css\" or \"js\" extensions.');\n          return;\n        }\n\n        if (options.filenames) {\n          buildmessage.error(\"Plugin.registerMinifier does not accept `filenames`\");\n          return;\n        }\n\n        Plugin._registerSourceProcessor(options || {}, factory, {\n          sourceProcessorSet: isopack.sourceProcessors.minifier,\n          methodName: \"registerMinifier\",\n          featurePackage: \"isobuild:minifier-plugin\"\n        });\n      },\n\n      nudge: function () {\n        Console.nudge(true);\n      },\n\n      convertToOSPath: files.convertToOSPath,\n      convertToStandardPath: files.convertToStandardPath,\n      path: {\n        join: files.pathJoin,\n        normalize: files.pathNormalize,\n        relative: files.pathRelative,\n        resolve: files.pathResolve,\n        dirname: files.pathDirname,\n        basename: files.pathBasename,\n        extname: files.pathExtname,\n        sep: files.pathSep\n      },\n      fs: files.fsFixPath\n    };\n    return Plugin;\n  },\n\n  // Load a Isopack on disk.\n  //\n  // options:\n  // - isopackBuildInfoJson: parsed isopack-buildinfo.json object,\n  //   if loading from an IsopackCache.\n  initFromPath: Profile(\n    \"Isopack#initFromPath\", function (name, dir, options) {\n    var self = this;\n    options = _.clone(options || {});\n    options.firstIsopack = true;\n\n    if (options.pluginCacheDir) {\n      self.pluginCacheDir = options.pluginCacheDir;\n    }\n\n    return self._loadUnibuildsFromPath(name, dir, options);\n  }),\n\n  _loadUnibuildsFromPath: function (name, dir, options) {\n    var self = this;\n    options = options || {};\n\n    // In the tropohouse, isopack paths are symlinks (which can be updated if\n    // more unibuilds are merged in). For any given call to\n    // _loadUnibuildsFromPath, let's ensure we see a consistent isopack by\n    // realpath'ing dir.\n    dir = files.realpath(dir);\n\n    var {metadata: mainJson} = Isopack.readMetadataFromDirectory(dir);\n    if (! mainJson) {\n      throw new Error(\"No metadata files found for isopack at: \" + dir);\n    }\n\n    // isopacks didn't used to know their name, but they should.\n    if (_.has(mainJson, 'name') && name !== mainJson.name) {\n      throw new Error(\"isopack \" + name + \" thinks its name is \" +\n                      mainJson.name);\n    }\n\n    // If we're loading from an IsopackCache, we need to load the WatchSets\n    // which will be used by the bundler.  (builtBy is only used by\n    // IsopackCache._checkUpToDate. pluginProviderPackageMap will actually be\n    // set by IsopackCache afterwards, because it has access to an appropriate\n    // PackageMap which can be subset to create a new PackageMap object.)\n    var unibuildWatchSets = {};\n    if (options.isopackBuildInfoJson) {\n      if (! options.firstIsopack) {\n        throw Error(\"can't merge isopacks with buildinfo\");\n      }\n\n      // XXX should comprehensively sanitize (eg, typecheck) everything\n      // read from json files\n\n      // Read the watch sets for each unibuild\n      _.each(\n        options.isopackBuildInfoJson.unibuildDependencies,\n        function (watchSetJSON, unibuildTag) {\n          unibuildWatchSets[unibuildTag] =\n            watch.WatchSet.fromJSON(watchSetJSON);\n        });\n\n      // Read pluginWatchSet. (In the multi-sub-isopack case, these are\n      // guaranteed to be trivial (since we check that there's no\n      // isopackBuildInfoJson), so no need to merge.)\n      self.pluginWatchSet = watch.WatchSet.fromJSON(\n        options.isopackBuildInfoJson.pluginDependencies);\n    }\n\n    // If we are loading multiple isopacks, only take this stuff from the\n    // first one.\n    if (options.firstIsopack) {\n      self.name = name;\n      self.metadata = {\n        summary: mainJson.summary\n      };\n      self.version = mainJson.version;\n      self.isTest = mainJson.isTest;\n      self.debugOnly = !!mainJson.debugOnly;\n      self.prodOnly = !!mainJson.prodOnly;\n      self.testOnly = !!mainJson.testOnly;\n    }\n    _.each(mainJson.plugins, function (pluginMeta) {\n      rejectBadPath(pluginMeta.path);\n\n      var plugin = bundler.readJsImage(files.pathJoin(dir, pluginMeta.path));\n\n      if (!_.has(self.plugins, pluginMeta.name)) {\n        self.plugins[pluginMeta.name] = {};\n      }\n      // If we already loaded a plugin of this name/arch, just ignore this one.\n      if (!_.has(self.plugins[pluginMeta.name], plugin.arch)) {\n        self.plugins[pluginMeta.name][plugin.arch] = plugin;\n      }\n    });\n    self.pluginsBuilt = true;\n    _.each(mainJson.builds, function (unibuildMeta) {\n      // aggressively sanitize path (don't let it escape to parent\n      // directory)\n      rejectBadPath(unibuildMeta.path);\n\n      // Skip unibuilds we already have.\n      var alreadyHaveUnibuild = _.find(self.unibuilds, function (unibuild) {\n        return unibuild.arch === unibuildMeta.arch;\n      });\n      if (alreadyHaveUnibuild) {\n        return;\n      }\n\n      var unibuildJson = JSON.parse(\n        files.readFile(files.pathJoin(dir, unibuildMeta.path)));\n\n      var unibuildBasePath =\n        files.pathDirname(files.pathJoin(dir, unibuildMeta.path));\n\n      if (unibuildJson.format !== \"unipackage-unibuild-pre1\" &&\n          unibuildJson.format !== \"isopack-2-unibuild\") {\n        throw new Error(\"Unsupported isopack unibuild format: \" +\n                        JSON.stringify(unibuildJson.format));\n      }\n\n      // Is this unibuild the legacy pre-\"compiler plugin\" format which contains\n      // \"prelink\" resources of pre-processed JS files (as well as the\n      // \"packageVariables\" field) instead of individual \"source\" resources (and\n      // a \"declaredExports\" field)?\n      var unibuildHasPrelink =\n            unibuildJson.format === \"unipackage-unibuild-pre1\";\n\n      var resources = [];\n\n      _.each(unibuildJson.resources, function (resource) {\n        rejectBadPath(resource.file);\n        var data = files.readBufferWithLengthAndOffset(\n          files.pathJoin(unibuildBasePath, resource.file),\n          resource.length, resource.offset);\n\n        if (resource.type === \"prelink\") {\n          if (! unibuildHasPrelink) {\n            throw Error(\"Unexpected prelink resource in \" +\n                        unibuildJson.format + \" at \" + dir);\n          }\n          // We found a \"prelink\" resource, because we're processing a package\n          // published with an older version of Meteor which did not create\n          // isopack-2 isopacks and which always preprocessed and linked all JS\n          // files instead of leaving that until bundle time.  Let's pretend it\n          // was just a single js source file, but leave a \"legacyPrelink\" field\n          // on it so we can not re-link that part (and not re-analyze for\n          // assigned variables).\n          var prelinkResource = {\n            type: \"source\",\n            extension: \"js\",\n            data: data,\n            path: resource.servePath,\n            // It's a shame to have to calculate the hash here instead of having\n            // it on disk, but this only runs for legacy packages anyway.\n            hash: watch.sha1(data),\n            // Legacy prelink files definitely don't have a source processor!\n            // They were created by an Isobuild that didn't even know about\n            // source processors!\n            usesDefaultSourceProcessor: true,\n            legacyPrelink: {\n              packageVariables: unibuildJson.packageVariables || []\n            }\n          };\n          if (resource.sourceMap) {\n            rejectBadPath(resource.sourceMap);\n            prelinkResource.legacyPrelink.sourceMap = files.readFile(\n              files.pathJoin(unibuildBasePath, resource.sourceMap), 'utf8');\n          }\n          resources.push(prelinkResource);\n        } else if (resource.type === \"source\") {\n          resources.push({\n            type: \"source\",\n            extension: resource.extension,\n            usesDefaultSourceProcessor:\n              !! resource.usesDefaultSourceProcessor,\n            data: data,\n            path: resource.path,\n            hash: resource.hash,\n            fileOptions: resource.fileOptions\n          });\n        } else if (_.contains([\"head\", \"body\", \"css\", \"js\", \"asset\"],\n                              resource.type)) {\n          resources.push({\n            type: resource.type,\n            data: data,\n            servePath: resource.servePath || undefined,\n            path: resource.path || undefined\n          });\n        } else {\n          throw new Error(\"bad resource type in isopack: \" +\n                          JSON.stringify(resource.type));\n        }\n      });\n\n      var declaredExports;\n      if (unibuildHasPrelink) {\n        // Legacy unibuild; it stores packageVariables and says some of them\n        // are exports.\n        declaredExports = [];\n        _.each(unibuildJson.packageVariables, function (pv) {\n          if (pv.export) {\n            declaredExports.push({\n              name: pv.name,\n              testOnly: pv.export === 'tests'\n            });\n          }\n        });\n      } else {\n        declaredExports = unibuildJson.declaredExports || [];\n      }\n\n      unibuildJson.uses && unibuildJson.uses.forEach((use) => {\n        if (!use.weak && compiler.isIsobuildFeaturePackage(use.package) &&\n            self.isobuildFeatures.indexOf(use.package) === -1) {\n          self.isobuildFeatures.push(use.package);\n        }\n      });\n\n      // Rebuild binary npm packages if unibuild arch matches host arch.\n      const rebuildBinaries = archinfo.matches(\n        archinfo.host(),\n        unibuildMeta.arch\n      );\n\n      const nodeModulesDirectories = bundler.NodeModulesDirectory\n        .readDirsFromJSON(unibuildJson.node_modules, {\n          packageName: self.name,\n          sourceRoot: unibuildBasePath,\n          rebuildBinaries,\n        });\n\n      self.unibuilds.push(new Unibuild(self, {\n        // At some point we stopped writing 'kind's to the metadata file, so\n        // default to main.\n        kind: unibuildMeta.kind || 'main',\n        arch: unibuildMeta.arch,\n        uses: unibuildJson.uses,\n        implies: unibuildJson.implies,\n        watchSet: unibuildWatchSets[unibuildMeta.path],\n        nodeModulesDirectories,\n        declaredExports: declaredExports,\n        resources: resources\n      }));\n    });\n\n    self.cordovaDependencies = mainJson.cordovaDependencies || null;\n\n    _.each(mainJson.tools, function (toolMeta) {\n      toolMeta.rootDir = dir;\n      // XXX check for overlap\n      self.toolsOnDisk.push(toolMeta);\n    });\n\n    return true;\n  },\n\n  hasCordovaUnibuild: function () {\n    var self = this;\n    return _.any(self.unibuilds, function (unibuild) {\n      return unibuild.arch === 'web.cordova';\n    });\n  },\n\n  canWriteLegacyBuilds() {\n    function isResourceSafeForLegacyBuilds(resource) {\n      // The only new kind of resource is \"source\"; other resources are\n      // unchanged from legacy builds.\n      if (resource.type !== \"source\") {\n        return true;\n      }\n\n      // CSS is safe for legacy builds. (We assume everyone is using the\n      // SourceProcessor from the 'meteor' package.)\n      if (resource.extension === \"css\") {\n        return true;\n      }\n\n      // If this JS resource uses hard-coded support for plain old ES5, then it\n      // is safe to write as part of a legacy Isopack.\n      if (resource.extension === \"js\" && resource.usesDefaultSourceProcessor) {\n        return true;\n      }\n\n      // Nope, this package cannot be represented as an isopack-1 Isopack\n      // because it uses a file implemented by registerCompiler other than the\n      // very basic JS and CSS types.\n      return false;\n    }\n\n    return this.unibuilds.every(\n      unibuild => unibuild.resources.every(isResourceSafeForLegacyBuilds)\n    );\n  },\n\n  // options:\n  //\n  // - includeIsopackBuildInfo: If set, write an isopack-buildinfo.json file.\n  // - includePreCompilerPluginIsopackVersions: By default, saveToPath only\n  //   creates an isopack of format 'isopack-2', with unibuilds of format\n  //   'isopack-2-unibuild'.  These isopacks may contain \"source\" resources,\n  //   which are processed at *bundle* time by compiler plugins.  They cannot be\n  //   properly processed by older tools.  If this flag is set, saveToPath also\n  //   tries to save data for older formats (isopack-1 and unipackage-pre2),\n  //   converting JS and CSS \"source\" resources into \"prelink\" and \"css\"\n  //   resources.  This is not possible if there are \"source\" resources other\n  //   than JS or CSS; however, such packages must indirectly depend on the\n  //   \"isobuild:compiler-plugin\" pseudo-package which is not compatible with\n  //   older releases.  For packages that can't be converted to the older\n  //   format, this function silently only saves the newer format.  (The point\n  //   of this flag is allow us to optimize cases that never need to write the\n  //   older format, such as the per-app isopack cache.)\n  // - isopackCache: isopack cache in which this isopack is registered\n  saveToPath: Profile(\"Isopack#saveToPath\", function (outputDir, {\n    includePreCompilerPluginIsopackVersions,\n    includeIsopackBuildInfo,\n    isopackCache = null,\n  } = {}) {\n    var self = this;\n    var outputPath = outputDir;\n\n    var builder = new Builder({ outputPath: outputPath });\n    try {\n      var mainJson = {\n        name: self.name,\n        summary: self.metadata.summary,\n        version: self.version,\n        isTest: self.isTest,\n        builds: [],\n        plugins: []\n      };\n\n      if (self.debugOnly) {\n        mainJson.debugOnly = true;\n      }\n      if (self.prodOnly) {\n        mainJson.prodOnly = true;\n      }\n      if (self.testOnly) {\n        mainJson.testOnly = true;\n      }\n      if (! _.isEmpty(self.cordovaDependencies)) {\n        mainJson.cordovaDependencies = self.cordovaDependencies;\n      }\n\n      const writeLegacyBuilds = (\n        includePreCompilerPluginIsopackVersions\n          && self.canWriteLegacyBuilds());\n\n      var isopackBuildInfoJson = null;\n      if (includeIsopackBuildInfo) {\n        isopackBuildInfoJson = {\n          builtBy: compiler.BUILT_BY,\n          unibuildDependencies: {},\n          // pluginDependencies defines a WatchSet that any package that could\n          // use this package as a plugin needs to watch. So it always contains\n          // our package.js (because modifications to package.js could add a new\n          // plugin), as well as any files making up plugins in our package.\n          pluginDependencies: self.pluginWatchSet.toJSON(),\n          pluginProviderPackageMap: self.pluginProviderPackageMap.toJSON(),\n          includeCordovaUnibuild: self.hasCordovaUnibuild()\n        };\n      }\n\n      // XXX COMPAT WITH 0.9.3\n      builder.reserve(\"unipackage.json\");\n\n      builder.reserve(\"isopack.json\");\n      // Reserve this even if includeIsopackBuildInfo is not set, to ensure\n      // nothing else writes it somehow.\n      builder.reserve(\"isopack-buildinfo.json\");\n\n      builder.reserve(\"head\");\n      builder.reserve(\"body\");\n\n      // Map from absolute path to npm directory in the unibuild, to the\n      // generated filename in the isopack we're writing.  Multiple builds\n      // can use the same npm modules (though maybe not any more, since tests\n      // have been separated?), but also there can be different sets of\n      // directories as well (eg, for a isopack merged with from multiple\n      // isopacks with _loadUnibuildsFromPath).\n      const npmDirsToCopy = Object.create(null);\n\n      // Pre-linker versions of Meteor expect all packages in the warehouse to\n      // contain a file called \"package.js\"; they use this as part of deciding\n      // whether or not they need to download a new package. Because packages\n      // are downloaded by the *existing* version of the tools, we need to\n      // include this file until we're comfortable breaking \"meteor update\" from\n      // 0.6.4.  (Specifically, warehouse.packageExistsInWarehouse used to check\n      // to see if package.js exists instead of just looking for the package\n      // directory.)\n      // XXX Remove this once we can.\n      builder.write(\"package.js\", {\n        data: Buffer.from(\n          (\"// This file is included for compatibility with the Meteor \" +\n           \"0.6.4 package downloader.\\n\"),\n          \"utf8\")\n      });\n\n      var unibuildInfos = [];\n\n      // Unibuilds\n      _.each(self.unibuilds, function (unibuild) {\n        // Make up a filename for this unibuild\n        var baseUnibuildName = unibuild.arch;\n        var unibuildDir =\n          builder.generateFilename(baseUnibuildName, { directory: true });\n        var unibuildJsonFile =\n          builder.generateFilename(baseUnibuildName + \".json\");\n        mainJson.builds.push({\n          kind: unibuild.kind,\n          arch: unibuild.arch,\n          path: unibuildJsonFile\n        });\n\n        var jsResourcesForLegacyPrelink = [];\n\n        // Save unibuild dependencies. Keyed by the json path rather than thinking\n        // too hard about how to encode pair (name, arch).\n        if (isopackBuildInfoJson) {\n          isopackBuildInfoJson.unibuildDependencies[unibuildJsonFile] =\n            unibuild.watchSet.toJSON();\n        }\n\n        // Figure out where the npm dependencies go.\n        let node_modules = {};\n        _.each(unibuild.nodeModulesDirectories, nmd => {\n          const bundlePath = _.has(npmDirsToCopy, nmd.sourcePath)\n            // We already have this npm directory from another unibuild.\n            ? npmDirsToCopy[nmd.sourcePath]\n            : npmDirsToCopy[nmd.sourcePath] = builder.generateFilename(\n              nmd.getPreferredBundlePath(\"isopack\"),\n              { directory: true }\n            );\n          node_modules[bundlePath] = nmd.toJSON();\n        });\n\n        const preferredPaths = Object.keys(node_modules);\n        if (preferredPaths.length === 1) {\n          // For backwards compatibility, if there's only one node_modules\n          // directory, store it as a single string.\n          node_modules = preferredPaths[0];\n        }\n\n        // Construct unibuild metadata\n        var unibuildJson = {\n          format: \"isopack-2-unibuild\",\n          declaredExports: unibuild.declaredExports,\n          uses: _.map(unibuild.uses, function (u) {\n            return {\n              'package': u.package,\n              // For cosmetic value, leave false values for these options out of\n              // the JSON file.\n              constraint: u.constraint || undefined,\n              unordered: u.unordered || undefined,\n              weak: u.weak || undefined\n            };\n          }),\n          implies: (_.isEmpty(unibuild.implies) ? undefined : unibuild.implies),\n          resources: []\n        };\n\n        if (preferredPaths.length > 0) {\n          // If there are no node_modules directories, don't confuse older\n          // versions of Meteor by storing an empty object.\n          unibuildJson.node_modules = node_modules;\n        }\n\n        const usesModules = ! isopackCache ||\n          isopackCache.uses(self, \"modules\", unibuild.arch);\n\n        // Output 'head', 'body' resources nicely\n        var concat = { head: [], body: [] };\n        var offset = { head: 0, body: 0 };\n        _.each(unibuild.resources, function (resource) {\n          if (_.contains([\"head\", \"body\"], resource.type)) {\n            if (concat[resource.type].length) {\n              concat[resource.type].push(Buffer.from(\"\\n\", \"utf8\"));\n              offset[resource.type]++;\n            }\n            if (! (resource.data instanceof Buffer)) {\n              throw new Error(\"Resource data must be a Buffer\");\n            }\n\n            if (! usesModules &&\n                resource.fileOptions &&\n                resource.fileOptions.lazy) {\n              // Omit lazy resources from the unibuild JSON file.\n              return;\n            }\n\n            unibuildJson.resources.push({\n              type: resource.type,\n              file: files.pathJoin(unibuildDir, resource.type),\n              length: resource.data.length,\n              offset: offset[resource.type]\n            });\n\n            concat[resource.type].push(resource.data);\n            offset[resource.type] += resource.data.length;\n          }\n        });\n\n        _.each(concat, function (parts, type) {\n          if (parts.length) {\n            builder.write(files.pathJoin(unibuildDir, type), {\n              data: Buffer.concat(concat[type], offset[type])\n            });\n          }\n        });\n\n        // Output other resources each to their own file\n        _.each(unibuild.resources, function (resource) {\n          if (_.contains([\"head\", \"body\"], resource.type)) {\n            // already did this one\n            return;\n          }\n\n          const generatedFilename =\n            builder.writeToGeneratedFilename(\n              files.pathJoin(unibuildDir,\n                             resource.servePath || resource.path),\n              { data: resource.data });\n\n          if (! usesModules &&\n              resource.fileOptions &&\n              resource.fileOptions.lazy) {\n            // Omit lazy resources from the unibuild JSON file, but only\n            // after they are copied into the bundle (immediately above).\n            return;\n          }\n\n          // If we're going to write a legacy prelink file later, track the\n          // original form of the resource object (with the source in a Buffer,\n          // etc) instead of the later version.  #HardcodeJs\n          if (writeLegacyBuilds &&\n              resource.type === \"source\" &&\n              resource.extension == \"js\") {\n            jsResourcesForLegacyPrelink.push({\n              data: resource.data,\n              hash: resource.hash,\n              servePath: unibuild.pkg._getServePath(resource.path),\n              bare: resource.fileOptions && resource.fileOptions.bare,\n              sourceMap: resource.sourceMap,\n              // If this file was actually read from a legacy isopack and is\n              // itself prelinked, this will be an object with some metadata\n              // about it, and we can skip re-running prelink later.\n              legacyPrelink: resource.legacyPrelink\n            });\n          }\n\n          unibuildJson.resources.push({\n            type: resource.type,\n            extension: resource.extension,\n            file: generatedFilename,\n            length: resource.data.length,\n            offset: 0,\n            usesDefaultSourceProcessor:\n              resource.usesDefaultSourceProcessor || undefined,\n            servePath: resource.servePath || undefined,\n            path: resource.path || undefined,\n            hash: resource.hash || undefined,\n            fileOptions: resource.fileOptions || undefined\n          });\n        });\n\n        // Control file for unibuild\n        builder.writeJson(unibuildJsonFile, unibuildJson);\n        unibuildInfos.push({\n          unibuild: unibuild,\n          unibuildJson: unibuildJson,\n          jsResourcesForLegacyPrelink: jsResourcesForLegacyPrelink\n        });\n      });\n\n      // If unibuilds included node_modules, copy them in.\n      _.each(npmDirsToCopy, (bundlePath, sourcePath) => {\n        builder.copyDirectory({\n          from: sourcePath,\n          to: bundlePath,\n          npmDiscards: self.npmDiscards,\n          symlink: false\n        });\n      });\n\n      // Plugins\n      _.each(self.plugins, function (pluginsByArch, name) {\n        _.each(pluginsByArch, function (plugin) {\n          // XXX the name of the plugin doesn't typically contain a colon, but\n          // escape it just in case.\n          var pluginDir = builder.generateFilename(\n            'plugin.' + colonConverter.convert(name) + '.' + plugin.arch,\n            { directory: true });\n          var pluginBuild = plugin.write(builder.enter(pluginDir));\n          var pluginEntry = {\n            name: name,\n            arch: plugin.arch,\n            path: files.pathJoin(pluginDir, pluginBuild.controlFile)\n          };\n          mainJson.plugins.push(pluginEntry);\n        });\n      });\n\n      // Tools\n      // First, are we supposed to include our own source as a tool?\n      if (self.includeTool) {\n        var toolsJson = self._writeTool(builder);\n        mainJson.tools = toolsJson;\n      }\n      // Next, what about other tools we may be merging from other isopacks?\n      // XXX check for overlap\n      _.each(self.toolsOnDisk, function (toolMeta) {\n        toolMeta = _.clone(toolMeta);\n        var rootDir = toolMeta.rootDir;\n        delete toolMeta.rootDir;\n        builder.copyDirectory({\n          from: files.pathJoin(rootDir, toolMeta.path),\n          to: toolMeta.path,\n          symlink: false\n        });\n        if (!mainJson.tools) {\n          mainJson.tools = [];\n        }\n        mainJson.tools.push(toolMeta);\n      });\n\n      var mainLegacyJson = null;\n      if (writeLegacyBuilds) {\n        mainLegacyJson = _.clone(mainJson);\n        mainLegacyJson.builds = [];\n\n        _.each(unibuildInfos, function (unibuildInfo) {\n          var unibuild = unibuildInfo.unibuild;\n          var unibuildJson = unibuildInfo.unibuildJson;\n          var jsResourcesForLegacyPrelink =\n                unibuildInfo.jsResourcesForLegacyPrelink;\n          var legacyFilename = builder.generateFilename(\n            unibuild.arch + '-legacy.json');\n          var legacyDir = unibuild.arch + '-legacy';\n          mainLegacyJson.builds.push({\n            kind: unibuild.kind,\n            arch: unibuild.arch,\n            path: legacyFilename\n          });\n\n          unibuildJson.format = 'unipackage-unibuild-pre1';\n          var newResources = [];\n          _.each(unibuildJson.resources, function (resource) {\n            if (resource.type !== 'source') {\n              newResources.push(resource);\n            } else if (resource.extension === 'css') {\n              // Convert this resource from a new-style \"source\" to an\n              // old-style \"css\".\n              newResources.push({\n                type: 'css',\n                file: resource.file,\n                length: resource.length,\n                offset: resource.offset,\n                servePath: self._getServePath(resource.path)\n              });\n            } else if (resource.extension === 'js') {\n              // Skip; we saved this in jsResourcesForLegacyPrelink above\n              // already, in the format that linker.prelink understands.\n            } else {\n              throw Error(\n                \"shouldn't write legacy builds for non-JS/CSS source \"\n                  + JSON.stringify(resource));\n            }\n          });\n\n          var prelinkFile, prelinkData, packageVariables;\n          if (jsResourcesForLegacyPrelink.length === 1 &&\n              jsResourcesForLegacyPrelink[0].legacyPrelink) {\n            // Aha!  This isopack was actually a legacy isopack in the first\n            // place! So this source file is already the output of prelink,\n            // and we don't need to reprocess it.\n            prelinkFile = jsResourcesForLegacyPrelink[0];\n            // XXX It's weird that the type of object going in and out of\n            // linker.prelink is different (so that this prelinkData\n            // assignment differs from that below), ah well.\n            prelinkData = prelinkFile.data;\n            packageVariables =\n              jsResourcesForLegacyPrelink[0].legacyPrelink.packageVariables;\n          } else {\n            // Determine captured variables, legacy way. First, start with the\n            // exports. We'll add the package variables after running prelink.\n            packageVariables = [];\n            var packageVariableNames = {};\n            _.each(unibuild.declaredExports, function (symbol) {\n              if (_.has(packageVariableNames, symbol.name)) {\n                return;\n              }\n              packageVariables.push({\n                name: symbol.name,\n                export: symbol.testOnly? \"tests\" : true\n              });\n              packageVariableNames[symbol.name] = true;\n            });\n\n            if (jsResourcesForLegacyPrelink.length) {\n              // Not originally legacy; let's run prelink to make it legacy.\n              var results = linker.prelink({\n                inputFiles: jsResourcesForLegacyPrelink,\n                // I was confused about this, so I am leaving a comment -- the\n                // combinedServePath is either [pkgname].js or [pluginName]:plugin.js.\n                // XXX: If we change this, we can get rid of source arch names!\n                combinedServePath: (\n                  \"/packages/\" + colonConverter.convert(\n                    unibuild.pkg.name +\n                      (unibuild.kind === \"main\" ? \"\" : (\":\" + unibuild.kind)) +\n                      \".js\")),\n                name: unibuild.pkg.name\n              });\n              if (results.files.length !== 1) {\n                throw Error(\"prelink should return 1 file, not \" +\n                            results.files.length);\n              }\n              prelinkFile = results.files[0];\n              prelinkData = Buffer.from(prelinkFile.source, 'utf8');\n\n              _.each(results.assignedVariables, function (name) {\n                if (_.has(packageVariableNames, name)) {\n                  return;\n                }\n                packageVariables.push({\n                  name: name\n                });\n                packageVariableNames[name] = true;\n              });\n            }\n          }\n\n          if (prelinkFile && prelinkData) {\n            var prelinkResource = {\n              type: 'prelink',\n              file: builder.writeToGeneratedFilename(\n                files.pathJoin(legacyDir, prelinkFile.servePath),\n                { data: prelinkData }),\n              length: prelinkData.length,\n              offset: 0,\n              servePath: prelinkFile.servePath || undefined\n            };\n            if (prelinkFile.sourceMap) {\n              // It appears in node v0.10.x, `new Buffer({someobject: 1})`\n              // would be silently swallowed. (leaving an empty buffer)\n              // In node v4+ this same code throws an error.\n              // XX - Not 100% sure what prelinkFile.sourceMap _can_ be,\n              //      so here's some exhaustive checking of things buffer\n              //      _will_ accept.\n              var acceptedByBuffer = _.isString(prelinkFile.sourceMap)\n                    || _.isNumber(prelinkFile.sourceMap)\n                    || _.isArray(prelinkFile.sourceMap)\n                    || (prelinkFile.sourceMap instanceof Buffer);\n              if (!acceptedByBuffer) {\n                prelinkFile.sourceMap = JSON.stringify(prelinkFile.sourceMap);\n              }\n              // Write the source map.\n\n              if (typeof prelinkFile.sourceMap !== \"string\") {\n                prelinkFile.sourceMap = JSON.stringify(prelinkFile.sourceMap);\n              }\n\n              prelinkResource.sourceMap = builder.writeToGeneratedFilename(\n                files.pathJoin(legacyDir, prelinkFile.servePath + '.map'),\n                { data: Buffer.from(prelinkFile.sourceMap, 'utf8') }\n              );\n            }\n            newResources.push(prelinkResource);\n          }\n\n          if (packageVariables.length) {\n            unibuildJson.packageVariables = packageVariables;\n          }\n\n          unibuildJson.resources = newResources;\n          delete unibuildJson.declaredExports;\n          builder.writeJson(legacyFilename, unibuildJson);\n        });\n\n        // old unipackage.json format/filename.  no point to save this if\n        // we can't even support isopack-1.\n        // XXX COMPAT WITH 0.9.3\n        builder.writeJson(\n          \"unipackage.json\",\n          Isopack.convertIsopackFormat(\n            // Note that mainLegacyJson is isopack-1 (has no \"source\" resources)\n            // rather than isopack-2.\n            mainLegacyJson, \"isopack-1\", \"unipackage-pre2\"));\n      }\n\n      var isopackJson = {};\n      isopackJson['isopack-2'] = mainJson;\n      if (writeLegacyBuilds) {\n        isopackJson['isopack-1'] = mainLegacyJson;\n      }\n\n      // writes one file with all of the new formats, so that it is possible\n      // to invent a new format and have old versions of meteor still read the\n      // old format\n      //\n      // This looks something like:\n      // {\n      //   isopack-1: {... data ...},\n      //   isopack-2: {... data ...}\n      // }\n      builder.writeJson(\"isopack.json\", isopackJson);\n\n      if (isopackBuildInfoJson) {\n        builder.writeJson(\"isopack-buildinfo.json\", isopackBuildInfoJson);\n      }\n      builder.complete();\n    } catch (e) {\n      builder.abort();\n      throw e;\n    }\n  }),\n\n  _writeTool: Profile(\"Isopack#_writeTool\", function (builder) {\n    var self = this;\n\n    var pathsToCopy = utils.runGitInCheckout(\n      'ls-tree',\n      '-r',\n      '--name-only',\n      '--full-tree',\n      'HEAD',\n      // The actual trees to copy!\n      'tools', 'examples', 'LICENSE.txt', 'LICENSES',\n      'meteor', 'meteor.bat', 'scripts/admin/launch-meteor',\n      'packages/package-version-parser/package-version-parser.js',\n      'packages/meteor/flush-buffers-on-exit-in-windows.js');\n\n    // Trim blank line and unnecessary examples.\n    pathsToCopy = _.filter(pathsToCopy.split('\\n'), function (f) {\n      return f && !f.match(/^examples\\/other/) &&\n        !f.match(/^examples\\/unfinished/);\n    });\n\n    // Regexes matching paths to transpile using babel\n    var transpileRegexes = [\n      /^tools\\/[^\\/]+\\.js$/, // General tools files\n      /^tools\\/isobuild\\/[^\\/]+\\.js$/, // Isobuild files\n      /^tools\\/cli\\/[^\\/]+\\.js$/, // CLI files\n      /^tools\\/tool-env\\/[^\\/]+\\.js$/, // Tool initiation and clean up\n      /^tools\\/runners\\/[^\\/]+\\.js$/, // Parts of tool process\n      /^tools\\/packaging\\/[^\\/]+\\.js$/,\n      /^tools\\/packaging\\/catalog\\/[^\\/]+\\.js$/,\n      /^tools\\/utils\\/[^\\/]+\\.js$/,\n      /^tools\\/fs\\/[^\\/]+\\.js$/,\n      /^tools\\/meteor-services\\/[^\\/]+\\.js$/,\n      /^tools\\/tool-testing\\/[^\\/]+\\.js$/,\n      /^tools\\/console\\/[^\\/]+\\.js$/,\n      /^tools\\/cordova\\/[^\\/]+\\.js$/,\n      // We don't support running self-test from an install anymore\n    ];\n\n    // Split pathsToCopy into two arrays - one of files that should be copied\n    // directly, and one of files that should be transpiled with Babel\n    var pathsToTranspile = [];\n    var pathsToCopyStraight = [];\n    pathsToCopy.forEach((path) => {\n      var shouldTranspile =\n        _.some(transpileRegexes, (regex) => path.match(regex));\n\n      if (shouldTranspile) {\n        pathsToTranspile.push(path);\n      } else {\n        pathsToCopyStraight.push(path);\n      }\n    });\n\n    // Set up builder to write to the correct directory\n    var toolPath = 'mt-' + archinfo.host();\n    builder = builder.enter(toolPath);\n\n    // Transpile the files we selected\n    var babel = require(\"meteor-babel\");\n    pathsToTranspile.forEach((path) => {\n      var fullPath = files.convertToOSPath(\n        files.pathJoin(files.getCurrentToolsDir(), path));\n\n      var inputFileContents = files.readFile(fullPath, \"utf-8\");\n\n      // #RemoveInProd\n      // We don't actually want to load the babel auto-transpiler when we are\n      // in a Meteor installation where everything is already transpiled for us.\n      // Therefore, strip out that line in main.js\n      if (path === \"tools/tool-env/install-babel.js\" ||\n          path === \"tools/tool-env/source-map-retriever-stack.js\") {\n        inputFileContents = inputFileContents.replace(/^.*#RemoveInProd.*$/mg, \"\");\n      }\n\n      var babelOptions = babel.getDefaultOptions({\n        nodeMajorVersion: parseInt(process.versions.node)\n      });\n\n      _.extend(babelOptions, {\n        filename: path,\n        sourceFileName: \"/\" + path,\n        sourceMapTarget: path + \".map\",\n        sourceMap: true\n      });\n\n      var transpiled = babel.compile(inputFileContents, babelOptions);\n\n      var sourceMapUrlComment = \"//# sourceMappingURL=\" + files.pathBasename(path + \".map\");\n\n      builder.write(path, {\n        data: Buffer.from(transpiled.code + \"\\n\" + sourceMapUrlComment, 'utf8')\n      });\n\n      builder.write(path + \".map\", {\n        data: Buffer.from(JSON.stringify(transpiled.map), 'utf8')\n      });\n    });\n\n    var gitSha = utils.runGitInCheckout('rev-parse', 'HEAD');\n    builder.reserve('isopackets', {directory: true});\n    builder.write('.git_version.txt', {data: Buffer.from(gitSha, 'utf8')});\n\n    builder.copyDirectory({\n      from: files.getCurrentToolsDir(),\n      to: '',\n      specificFiles: pathsToCopyStraight,\n      symlink: false\n    });\n\n    // Include the dev bundle, but drop a few things that are only used by\n    // self-test (which isn't supported from release).\n    var devBundleIgnore = _.clone(bundler.ignoreFiles);\n    devBundleIgnore.push(/BrowserStackLocal/, /browserstack-webdriver/);\n    builder.copyDirectory({\n      from: files.pathJoin(files.getDevBundle()),\n      to: 'dev_bundle',\n      ignore: devBundleIgnore,\n      symlink: false\n    });\n\n    requestGarbageCollection();\n\n    // Build all of the isopackets now, so that no build step is required when\n    // you're actually running meteor from a release in order to load packages.\n    var isopacketBuildContext = makeIsopacketBuildContext();\n\n    var messages = buildmessage.capture(function () {\n      // We rebuild them in the order listed in ISOPACKETS. This is not strictly\n      // necessary here, since any isopackets loaded as part of the build\n      // process are going to be the current tool's isopackets, not the\n      // isopackets that we're writing out.\n      _.each(ISOPACKETS, function (packages, isopacketName) {\n        requestGarbageCollection();\n\n        buildmessage.enterJob({\n          title: \"compiling \" + isopacketName + \" packages for the tool\"\n        }, function () {\n          isopacketBuildContext.isopackCache.buildLocalPackages(packages);\n          if (buildmessage.jobHasMessages()) {\n            return;\n          }\n\n          var image = bundler.buildJsImage({\n            name: \"isopacket-\" + isopacketName,\n            packageMap: isopacketBuildContext.packageMap,\n            isopackCache: isopacketBuildContext.isopackCache,\n            use: packages\n          }).image;\n          if (buildmessage.jobHasMessages()) {\n            return;\n          }\n\n          requestGarbageCollection();\n\n          image.write(\n            builder.enter(files.pathJoin('isopackets', isopacketName)));\n        });\n      });\n    });\n    // This is a build step ... but it's one that only happens in development,\n    // and similar to a isopacket load failure, it can just crash the app\n    // instead of being handled nicely.\n    if (messages.hasMessages()) {\n      Console.error(\"Errors prevented tool build:\");\n      Console.error(messages.formatMessages());\n      throw new Error(\"tool build failed?\");\n    }\n\n    return [{\n      name: 'meteor',\n      arch: archinfo.host(),\n      path: toolPath\n    }];\n  }),\n\n  getMergedWatchSet: Profile(\"Isopack#getMergedWatchSet\", function () {\n    var self = this;\n    var watchSet = self.pluginWatchSet.clone();\n    _.each(self.unibuilds, function (unibuild) {\n      watchSet.merge(unibuild.watchSet);\n    });\n    return watchSet;\n  }),\n\n  getClientWatchSet: Profile(\"Isopack#getClientWatchSet\", function () {\n    var watchSet = this.pluginWatchSet.clone();\n    _.each(this.unibuilds, function (unibuild) {\n      if (/^web\\./.test(unibuild.arch)) {\n        watchSet.merge(unibuild.watchSet);\n      }\n    });\n    return watchSet;\n  }),\n\n  getServerWatchSet: Profile(\"Isopack#getServerWatchSet\", function () {\n    var watchSet = this.pluginWatchSet.clone();\n    _.each(this.unibuilds, function (unibuild) {\n      if (! /^web\\./.test(unibuild.arch)) {\n        watchSet.merge(unibuild.watchSet);\n      }\n    });\n    return watchSet;\n  }),\n\n  // Similar to PackageSource.getPackagesToLoadFirst, but doesn't include\n  // packages used by plugins, because plugin dependencies are already\n  // statically included in this built Isopack. Used by\n  // IsopackCache._ensurePackageLoaded.\n  //\n  // Like getPackagesToLoadFirst, it filters out isobuild:* pseudo-packages and\n  // should not be used to create input to Version Solver.\n  getStrongOrderedUsedAndImpliedPackages: Profile(\n    \"Isopack#getStrongOrderedUsedAndImpliedPackages\", function () {\n    var self = this;\n    var packages = {};\n    var processUse = function (use) {\n      if (use.weak || use.unordered) {\n        return;\n      }\n      // Only include real packages, not isobuild:* pseudo-packages.\n      if (compiler.isIsobuildFeaturePackage(use.package)) {\n        return;\n      }\n      packages[use.package] = true;\n    };\n\n    _.each(self.unibuilds, function (unibuild) {\n      _.each(unibuild.uses, processUse);\n      _.each(unibuild.implies, processUse);\n    });\n    return _.keys(packages);\n  }),\n\n  featureEnabled(featurePackageName) {\n    return this.isobuildFeatures.indexOf(featurePackageName) !== -1;\n  },\n\n  _getServePath: function (pathInPackage) {\n    var self = this;\n    var serveRoot;\n    if (self.name) {\n      serveRoot = files.pathJoin('/packages/', self.name);\n    } else {\n      serveRoot = '/';\n    }\n\n    return colonConverter.convert(\n      files.pathJoin(\n        serveRoot,\n        // XXX or should everything in this API use slash already?\n        files.convertToStandardPath(pathInPackage, true)));\n  },\n\n  displayName() {\n    return this.name === null ? 'the app' : this.name;\n  }\n});\n\nexports.Isopack = Isopack;\n\nexports.OldIsopackFormatError = function () {\n  // This should always be caught anywhere where it can appear (ie, anywhere\n  // that isn't definitely loading something from the tropohouse).\n  this.toString = function () { return \"old isopack format!\" };\n};\n"]}