{"version":3,"sources":["/tools/utils/archinfo.js"],"names":["module","export","VALID_ARCHITECTURES","_","require","os","utils","_host","host","run","args","result","execFileSync","slice","stdout","Error","join","replace","platform","machine","contains","process","arch","exports","acceptableMeteorToolArches","architecture","canSwitchTo64Bit","matches","program","substr","length","mostSpecificMatch","programs","seen","best","each","p","archinfo","leastSpecificDescription","longest","max","withoutSpecificOs","extend"],"mappings":"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","file":"tools/utils/archinfo.js.map","sourcesContent":["var _ = require('underscore');\nvar os = require('os');\n\nvar utils = require('./utils.js');\n\n/* Meteor's current architecture scheme defines the following virtual\n * machine types, which are defined by specifying what is promised by\n * the host environment:\n *\n * browser.w3c\n *   A web browser compliant with modern standards. This is\n *   intentionally a broad definition. In the coming years, as web\n *   standards evolve, we will likely tighten it up.\n *\n * browser.ie[678]\n *   Old versions of Internet Explorer (not sure yet exactly which\n *   versions to distinguish -- maybe 6 and 8?)\n *\n * os.linux.x86_32\n * os.linux.x86_64\n *   Linux on Intel x86 architecture. x86_64 means a system that can\n *   run 64-bit images, furnished with 64-bit builds of shared\n *   libraries (there is no guarantee that 32-bit builds of shared\n *   libraries will be available). x86_32 means a system that can run\n *   32-bit images, furnished with 32-bit builds of shared libraries.\n *   Additionally, if a package contains shared libraries (for use by\n *   other packages), then if the package is built for x86_64, it\n *   should contain a 64-bit version of the library, and likewise for\n *   32-bit.\n *\n *   Operationally speaking, if you worked at it, under this\n *   definition it would be possible to build a Linux system that can\n *   run both x86_64 and x86_32 images (eg, by using a 64-bit kernel\n *   and making sure that both versions of all relevant libraries were\n *   installed). But we require such a host to decide whether it is\n *   x86_64 or x86_32, and stick with it. You can't load a combination\n *   of packages from each and expect them to work together, because\n *   if they contain shared libraries they all need to have the same\n *   architecture.\n *\n *   Basically the punchline is: if you installed the 32-bit version\n *   of Ubuntu, you've got a os.linux.x86_32 system and you will\n *   use exclusively os.linux.x86_32 packages, and likewise\n *   64-bit. They are two parallel universes and which one you're in\n *   is determined by which version of Red Hat or Ubuntu you\n *   installed.\n *\n * os.osx.x86_64\n *   OS X (technically speaking, Darwin) on Intel x86 architecture,\n *   with a kernel capable of loading 64-bit images, and 64-bit builds\n *   of shared libraries available.  If a os.osx.x86_64 package\n *   contains a shared library, it is only required to provide a\n *   64-bit version of the library (it is not required to provide a\n *   fat binary with both 32-bit and 64-bit builds).\n *\n *   Note that in modern Darwin, both the 32 and 64 bit versions of\n *   the kernel can load 64-bit images, and the Apple-supplied shared\n *   libraries are fat binaries that include both 32-bit and 64-bit\n *   builds in a single file. So it is technically fine (but\n *   discouraged) for a os.osx.x86_64 to include a 32-bit\n *   executable, if it only uses the system's shared libraries, but\n *   you'll run into problems if shared libraries from other packages\n *   are used.\n *\n *   There is no os.osx.x86_32. Our experience is that such\n *   hardware is virtually extinct. Meteor has never supported it and\n *   nobody has asked for it.\n *\n * os.windows.x86_32\n * os.windows.x86_64\n *   Once, on the far side of yesterday, there was not a 64-bit\n *   build of Meteor for Windows, due to the belief that Node didn't\n *   take (enough?) advantage of a 64-bit platform.  As time has passed,\n *   and as V8 engine improvements have been bestowed upon it, this is\n *   no longer as clear as it may have once been.  Node.js Foundation\n *   releases 64-bit versions themselves, likely for good reason.\n *   Present-day operation of 64-bit binaries on 64-bit Windows\n *   platforms show clear performance benefits over their 32-bit\n *   siblings (e.g. 7-zip, et.al), so Meteor should also try to offer\n *   that same benefit by building and offering a 64-bit version.\n *\n * To be (more but far from completely) precise, the ABI for os.*\n * architectures includes a CPU type, a mode in which the code will be\n * run (eg, 64 bit), an executable file format (eg, ELF), a promise to\n * make any shared libraries available in a particular architecture,\n * and promise to set up the shared library search path\n * \"appropriately\". In the future it will also include some guarantees\n * about the directory layout in the environment, eg, location of a\n * directory where temporary files may be freely written. It does not\n * include any syscalls (beyond those used by code that customarily is\n * statically linked into every executable built on a platform, eg,\n * exit(2)). It does not guarantee the presence of any particular\n * shared libraries or programs (including any particular shell or\n * traditional tools like 'grep' or 'find').\n *\n * To model the shared libraries that are required on a system (and\n * the particular versions that are required), and to model\n * dependencies on command-line programs like 'bash' and 'grep', the\n * idea is to have a package named something like 'posix-base' that\n * rolls up a reasonable base environment (including such modern\n * niceties as libopenssl) and is supplied by the container. This\n * allows it to be versioned, unlike architectures, which we hope to\n * avoid versioning.\n *\n * Q: What does \"x86\" mean?\n * A: It refers to the traditional Intel architecture, which\n * originally surfaced in CPUs such as the 8086 and the 80386. Those\n * of us who are older should remember that the last time that Intel\n * used this branding was the 80486, introduced in 1989, and that\n * today, parts that use this architecture bear names like \"Core\",\n * \"Atom\", and \"Phenom\", with no \"86\" it sight. We use it in the\n * architecture name anyway because we don't want to depart too far\n * from Linux's architecture names.\n *\n * Q: Why do we call it \"x86_32\" instead of the customary \"i386\" or\n * \"i686\"?\n * A: We wanted to have one name for 32-bit and one name for 64-bit,\n * rather than several names for each that are virtual synonyms for\n * each (eg, x86_64 vs amd64 vs ia64, i386 vs i686 vs x86). For the\n * moment anyway, we're willing to adopt a \"one size fits all\"\n * attitude to get there (no ability to have separate builds for 80386\n * CPUs that don't support Pentium Pro extensions, for example --\n * you'll have to do runtime detection if you need that). And as long\n * as we have to pick a name, we wanted to pick one that was super\n * clear (it is not obvious to many people that \"i686\" means \"32-bit\n * Intel\", because why should it be?) and didn't imply too close of an\n * equivalence to the precise meanings that other platforms may assign\n * to some of these strings.\n */\n\n// Valid architectures that Meteor officially supports.\nexport const VALID_ARCHITECTURES = {\n  \"os.osx.x86_64\": true,\n  \"os.linux.x86_64\": true,\n  \"os.linux.x86_32\": true,\n  \"os.windows.x86_64\": true,\n  \"os.windows.x86_32\": true,\n};\n\n// Returns the fully qualified arch of this host -- something like\n// \"os.linux.x86_32\" or \"os.osx.x86_64\". Must be called inside\n// a fiber. Throws an error if it's not a supported architecture.\n//\n// If you change this, also change scripts/admin/launch-meteor\nvar _host = null; // memoize\nvar host = function () {\n  if (! _host) {\n    var run = function (...args) {\n      var result = utils.execFileSync(args[0], args.slice(1)).stdout;\n      if (! result) {\n        throw new Error(\"can't get arch with \" + args.join(\" \") + \"?\");\n      }\n      return result.replace(/\\s*$/, ''); // trailing whitespace\n    };\n\n    var platform = os.platform();\n\n    if (platform === \"darwin\") {\n      // Can't just test uname -m = x86_64, because Snow Leopard can\n      // return other values.\n      if (run('uname', '-p') !== \"i386\" ||\n          run('sysctl', '-n', 'hw.cpu64bit_capable') !== \"1\") {\n        throw new Error(\"Only 64-bit Intel processors are supported on OS X\");\n      }\n      _host  = \"os.osx.x86_64\";\n    }\n\n    else if (platform === \"linux\") {\n      var machine = run('uname', '-m');\n      if (_.contains([\"i386\", \"i686\", \"x86\"], machine)) {\n        _host = \"os.linux.x86_32\";\n      } else if (_.contains([\"x86_64\", \"amd64\", \"ia64\"], machine)) {\n        _host = \"os.linux.x86_64\";\n      } else {\n        throw new Error(\"Unsupported architecture: \" + machine);\n      }\n    }\n\n    else if (platform === \"win32\") {\n      if (process.arch === \"x64\") {\n        _host = \"os.windows.x86_64\";\n      } else {\n        _host = \"os.windows.x86_32\";\n      }\n    } else {\n      throw new Error(\"Unsupported operating system: \" + platform);\n    }\n  }\n\n  return _host;\n};\n\n// In order to springboard to earlier Meteor releases that did not have\n// 64-bit Windows builds, Windows installations must be allowed to\n// download 32-bit builds of meteor-tool.\nexports.acceptableMeteorToolArches = function () {\n  if (os.platform() === \"win32\") {\n    switch (utils.architecture()) {\n    case \"x86_32\":\n      return [\"os.windows.x86_32\"];\n    case \"x86_64\":\n      return [\n        \"os.windows.x86_64\",\n        \"os.windows.x86_32\",\n      ];\n    }\n  }\n\n  return [host()];\n};\n\n// 64-bit Windows machines that have been using a 32-bit version of Meteor\n// are eligible to switch to 64-bit beginning with Meteor 1.6, which is\n// the first version of Meteor that contains this code.\nexports.canSwitchTo64Bit = function () {\n  // Automatically switching from 32-bit to 64-bit Windows builds is\n  // disabled for the time being, since downloading additional builds of\n  // meteor-tool isn't stable enough at the moment (on Windows, at least)\n  // to introduce in a release candidate.\n  return false &&\n    utils.architecture() === \"x86_64\" &&\n    host() === \"os.windows.x86_32\";\n};\n\n// True if `host` (an architecture name such as 'os.linux.x86_64') can run\n// programs of architecture `program` (which might be something like 'os',\n// 'os.linux', or 'os.linux.x86_64').\n//\n// `host` and `program` are just mnemonics -- `host` does not\n// necessarily have to be a fully qualified architecture name. This\n// function just checks to see if `program` describes a set of\n// environments that is a (non-strict) superset of `host`.\nvar matches = function (host, program) {\n  return host.substr(0, program.length) === program &&\n    (host.length === program.length ||\n     host.substr(program.length, 1) === \".\");\n};\n\n// Like `supports`, but instead taken an array of possible\n// architectures as its second argument. Returns the most specific\n// match, or null if none match. Throws an error if `programs`\n// contains exact duplicates.\nvar mostSpecificMatch = function (host, programs) {\n  var seen = {};\n  var best = null;\n\n  _.each(programs, function (p) {\n    if (seen[p]) {\n      throw new Error(\"Duplicate architecture: \" + p);\n    }\n    seen[p] = true;\n    if (archinfo.matches(host, p) &&\n        (! best || p.length > best.length)) {\n      best = p;\n    }\n  });\n\n  return best;\n};\n\n// `programs` is a set of architectures (as an array of string, which\n// may contain duplicates). Determine if there exists any architecture\n// that is compatible with all of the architectures in the set. If so,\n// returns the least specific such architecture. Otherwise (the\n// architectures are disjoin) raise an exception.\n//\n// For example, for 'os' and 'os.osx', return 'os.osx'. For 'os' and\n// 'os.linux.x86_64', return 'os.linux.x86_64'. For 'os' and 'browser', throw an\n// exception.\nvar leastSpecificDescription = function (programs) {\n  if (programs.length === 0) {\n    return '';\n  }\n\n  // Find the longest string\n  var longest = _.max(programs, function (p) { return p.length; });\n\n  // If everything else in the list is compatible with the longest,\n  // then it must be the most specific, and if everything is\n  // compatible with the most specific then it must be the least\n  // specific compatible description.\n  _.each(programs, function (p) {\n    if (! archinfo.matches(longest, p)) {\n      throw new Error(\"Incompatible architectures: '\" + p + \"' and '\" +\n                      longest + \"'\");\n    }\n  });\n\n  return longest;\n};\n\nvar withoutSpecificOs = function (arch) {\n  if (arch.substr(0, 3) === 'os.') {\n    return 'os';\n  }\n  return arch;\n};\n\nvar archinfo = exports;\n_.extend(archinfo, {\n  host: host,\n  matches: matches,\n  mostSpecificMatch: mostSpecificMatch,\n  leastSpecificDescription: leastSpecificDescription,\n  withoutSpecificOs: withoutSpecificOs\n});\n"]}