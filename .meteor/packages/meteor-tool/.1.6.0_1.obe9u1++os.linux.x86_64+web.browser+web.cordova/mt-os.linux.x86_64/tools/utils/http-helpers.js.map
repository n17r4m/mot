{"version":3,"sources":["/tools/utils/http-helpers.js"],"names":["Writable","module","watch","require","v","os","util","_","files","auth","config","release","Console","timeoutScaleFactor","ConcatStream","constructor","chunks","size","_write","chunk","encoding","next","push","length","getBuffer","Buffer","concat","end","force","WritableWithProgress","writable","listener","self","_inner","_listener","extend","prototype","write","callback","_progress","n","done","state","_state","current","progress","reportProgress","on","name","once","arguments","emit","getUserAgent","version","isCheckout","inCheckout","getToolsVersion","format","platform","type","arch","httpHelpers","exports","request","urlOrOptions","options","isObject","url","clone","outputStream","has","bodyStream","bodyStreamLength","responseLength","Error","headers","forceSSL","process","env","CAFILE","ca","readFile","followRedirect","useSessionHeader","useAuthHeader","sessionHeader","getSessionId","getAccountsDomain","authHeader","getSessionToken","promise","Promise","resolve","reject","err","response","body","setCookie","each","h","match","setSessionId","proxy","HTTP_PROXY","http_proxy","test","HTTPS_PROXY","https_proxy","timeout","onRequest","debug","method","req","error","isBuffer","contentLength","Number","actualLength","byteLength","call","isFunction","totalProgress","dest","pipe","_addProgressEvents","await","reportProgressDone","emitProgress","undefined","data","getUrl","result","e","OfflineError","href","statusCode","getUrlWithResuming","maxAttempts","retryDelaySecs","masterProgress","attempt","triesRemaining","startAt","Range","addChildTask","title","_title","useTry","change","setTimeout","then"],"mappings":"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","file":"tools/utils/http-helpers.js.map","sourcesContent":["///\n/// utility functions for dealing with urls and http\n///\n\nvar os = require('os');\nvar util = require('util');\n\nvar _ = require('underscore');\n\nvar files = require('../fs/files.js');\nvar auth = require('../meteor-services/auth.js');\nvar config = require('../meteor-services/config.js');\nvar release = require('../packaging/release.js');\nvar Console = require('../console/console.js').Console;\nvar timeoutScaleFactor = require('./utils.js').timeoutScaleFactor;\n\nimport { Writable } from \"stream\";\n\nclass ConcatStream extends Writable {\n  constructor() {\n    super();\n    this.chunks = [];\n    this.size = 0;\n  }\n\n  _write(chunk, encoding, next) {\n    this.chunks.push(chunk);\n    this.size += chunk.length;\n    next();\n  }\n\n  getBuffer() {\n    if (this.chunks.length !== 1) {\n      this.chunks[0] = Buffer.concat(this.chunks);\n      this.chunks.length = 1;\n    }\n\n    return this.chunks[0];\n  }\n\n  end(force = false) {\n    // Override the Writable#end method to ignore any .end() calls for\n    // this stream, since we likely want to resume the download later.\n    if (force === true) {\n      super.end();\n    }\n  }\n}\n\n// Helper that tracks bytes written to a writable\nvar WritableWithProgress = function (writable, listener) {\n  var self = this;\n  self._inner = writable;\n  self._listener = listener;\n};\n\n_.extend(WritableWithProgress.prototype, {\n  write: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk.length, false);\n    return self._inner.write(chunk, encoding);\n  },\n\n  end: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk ? chunk.length : 0, true);\n    return self._inner.end(chunk, encoding);\n  },\n\n  _progress: function (n, done) {\n    var self = this;\n\n    var state = self._state;\n    state.current += n;\n    if (done) {\n      state.current.done = true;\n    }\n    self.progress.reportProgress(state);\n  },\n\n  on: function (name, callback) {\n    return this._inner.on(name, callback);\n  },\n\n  once: function () {\n    return this._inner.once(...arguments);\n  },\n\n  emit: function () {\n    return this._inner.emit(...arguments);\n  }\n});\n\n\n// Compose a User-Agent header.\nvar getUserAgent = function () {\n  var version;\n\n  if (release.current) {\n    version = release.current.isCheckout() ? 'checkout' : release.current.name;\n  } else {\n    // This happens when we haven't finished starting up yet (say, the\n    // user passed --release 1.2.3 and we have to download 1.2.3\n    // before we can get going), or if we are using an installed copy\n    // of Meteor to 'meteor update'ing a project that was created by a\n    // checkout and doesn't have a version yet.\n    version = files.inCheckout() ? 'checkout' : files.getToolsVersion();\n  }\n\n  return util.format('Meteor/%s OS/%s (%s; %s; %s;)', version,\n                     os.platform(), os.type(), os.release(), os.arch());\n};\n\n\nvar httpHelpers = exports;\n_.extend(exports, {\n  getUserAgent: getUserAgent,\n\n  // A wrapper around request with the following improvements:\n  //\n  // - It will respect proxy environment variables if present\n  //   (HTTP_PROXY or HTTPS_PROXY as appropriate).\n  //\n  // - It will set a reasonable User-Agent header.\n  //\n  // - If you omit the callback it will run synchronously. The return\n  //   value will be an object with keys 'response' and 'body' (with\n  //   the same meaning as the arguments to request's normal\n  //   callback), or it will throw.\n  //\n  // - If Set-Cookie headers are present on the response, *and* you\n  //   are using a callback, it will parse the cookies and include\n  //   them as a setCookie attribute on the object passed to the\n  //   callback. setCookie is a simple map from cookie name to cookie\n  //   value. If you want expiration time and attributes you'll have\n  //   to parse it yourself. If there are multiple Set-Cookie headers\n  //   for the same cookie it is unspecified which one you'll get.\n  //\n  // - You can provide a 'bodyStream' option which is a stream that\n  //   will be used for the body of the request.\n  //\n  // - For authenticated MDG services, you can set the\n  //   'useSessionHeader' and/or 'useAuthHeader' options (to true) to\n  //   send X-Meteor-Session/X-Meteor-Auth headers using values from\n  //   the session file.\n  //\n  // - forceSSL is always set to true. Always. And followRedirect is\n  //   set to false since it doesn't understand origins (see comment\n  //   in implementation).\n  //\n  // - An optional options.onRequest callback may be provided if the\n  //   caller desires access to the request object.\n  //\n  // NB: With useSessionHeader and useAuthHeader, this function will\n  // read *and possibly write to* the session file, so if you are\n  // writing auth code (in auth.js) and you call it, be sure to reread\n  // the session file afterwards.\n  request: function (urlOrOptions, callback) {\n    var options;\n    if (!_.isObject(urlOrOptions)) {\n      options = { url: urlOrOptions };\n    } else {\n      options = _.clone(urlOrOptions);\n    }\n\n    var outputStream;\n    if (_.has(options, 'outputStream')) {\n      outputStream = options.outputStream;\n      delete options.outputStream;\n    }\n\n    var bodyStream;\n    if (_.has(options, 'bodyStream')) {\n      bodyStream = options.bodyStream;\n      delete options.bodyStream;\n    }\n\n    // Body stream length for progress\n    var bodyStreamLength = 0;\n    if (_.has(options, 'bodyStreamLength')) {\n      bodyStreamLength = options.bodyStreamLength;\n      delete options.bodyStreamLength;\n    } else {\n      // Guess the body stream length as 1MB\n      // Hopefully if it's much bigger the caller will set it\n      // If it is much small, we will pleasantly surprise the user!\n      if (bodyStream) {\n        bodyStreamLength = 1024 * 1024;\n      }\n    }\n\n    // Response length for progress\n    var responseLength = 128 * 1024;\n    if (_.has(options, 'responseLength')) {\n      responseLength = options.responseLength;\n      delete options.responseLength;\n    }\n\n    var progress = null;\n    if (_.has(options, 'progress')) {\n      progress = options.progress;\n      delete options.progress;\n\n      if (callback) {\n        throw new Error(\"Not safe to use progress with callback\");\n      }\n    }\n\n    options.headers = _.extend({\n      'User-Agent': getUserAgent()\n    }, options.headers || {});\n\n    // This should never, ever be false, or else why are you using SSL?\n    options.forceSSL = true;\n    if (process.env.CAFILE) {\n      options.ca = files.readFile(process.env.CAFILE);\n    }\n\n    // followRedirect is very dangerous because request does not\n    // appear to segregate cookies by origin, so any cookies (and\n    // apparently headers as well, eg X-Meteor-Auth) sent on the\n    // original request could get forwarded to an unexpected domain in\n    // a redirect. This is almost certainly not something you ever\n    // want.\n    options.followRedirect = false;\n\n    var useSessionHeader = options.useSessionHeader;\n    delete options.useSessionHeader;\n    var useAuthHeader = options.useAuthHeader;\n    delete options.useAuthHeader;\n    if (useSessionHeader || useAuthHeader) {\n      var sessionHeader = auth.getSessionId(config.getAccountsDomain());\n      if (sessionHeader) {\n        options.headers['X-Meteor-Session'] = sessionHeader;\n      }\n      if (callback) {\n        throw new Error(\"session header can't be used with callback\");\n      }\n    }\n    if (useAuthHeader) {\n      var authHeader = auth.getSessionToken(config.getAccountsDomain());\n      if (authHeader) {\n        options.headers['X-Meteor-Auth'] = authHeader;\n      }\n    }\n\n    var promise;\n    if (! callback) {\n      promise = new Promise(function (resolve, reject) {\n        callback = function (err, response, body) {\n          if (err) {\n            reject(err);\n            return;\n          }\n\n          var setCookie = {};\n          _.each(response.headers[\"set-cookie\"] || [], function (h) {\n            var match = h.match(/^([^=\\s]+)=([^;\\s]+)/);\n            if (match) {\n              setCookie[match[1]] = match[2];\n            }\n          });\n\n          if (useSessionHeader && _.has(response.headers, \"x-meteor-session\")) {\n            auth.setSessionId(config.getAccountsDomain(),\n                              response.headers['x-meteor-session']);\n          }\n\n          resolve({\n            response: response,\n            body: body,\n            setCookie: setCookie\n          });\n        };\n      });\n    }\n\n    // try to get proxy from environment.\n    // similar code is in packages/ddp/stream_client_nodejs.js\n    var proxy = process.env.HTTP_PROXY || process.env.http_proxy || null;\n    // if we're going to an https url, try the https_proxy env variable first.\n    if (/^https/i.test(options.url)) {\n      proxy = process.env.HTTPS_PROXY || process.env.https_proxy || proxy;\n    }\n    if (proxy && !options.proxy) {\n      options.proxy = proxy;\n    }\n\n    if (! _.has(options, \"timeout\")) {\n      // 60 seconds for timeout between initial response headers and data,\n      // and between chunks of data while reading the rest of the response.\n      options.timeout = 60 * 1000 * timeoutScaleFactor;\n    } else if (! (typeof options.timeout === \"number\" &&\n                  options.timeout > 0)) {\n      // The timeout can be disabled by passing anything other than a\n      // positive number, e.g. { timeout: null }.\n      delete options.timeout;\n    }\n\n    let onRequest;\n    if (_.has(options, \"onRequest\")) {\n      onRequest = options.onRequest;\n      delete options.onRequest;\n    }\n\n    // request is the most heavy-weight of the tool's npm dependencies; don't\n    // require it until we definitely need it.\n    Console.debug(\"Doing HTTP request: \", options.method || 'GET', options.url);\n    var request = require('request');\n    var req = request(options, function (error, response, body) {\n      if (! error &&\n          response &&\n          (typeof body === \"string\" ||\n           Buffer.isBuffer(body))) {\n        const contentLength = Number(response.headers[\"content-length\"]);\n        const actualLength = Buffer.byteLength(body);\n\n        if (contentLength > 0 &&\n            actualLength < contentLength) {\n          error = new Error(\n            \"Expected \" + contentLength + \" bytes in request body \" +\n              \"but received only \" + actualLength);\n        }\n      }\n\n      return callback.call(this, error, response, body);\n    });\n\n    if (_.isFunction(onRequest)) {\n      onRequest(req);\n    }\n\n    var totalProgress = { current: 0, end: bodyStreamLength + responseLength, done: false };\n\n    if (bodyStream) {\n      var dest = req;\n      if (progress) {\n        dest = new WritableWithProgress(dest, function (n, done) {\n          if (!totalProgress.done) {\n            totalProgress.current += n;\n            progress.reportProgress(totalProgress);\n          }\n        });\n      }\n      bodyStream.pipe(dest);\n    }\n\n    if (outputStream) {\n      req.pipe(outputStream);\n    }\n\n    if (progress) {\n      httpHelpers._addProgressEvents(req);\n      req.on('progress', function (state) {\n        if (!totalProgress.done) {\n          totalProgress.current = bodyStreamLength + state.current;\n          totalProgress.end = bodyStreamLength + state.end;\n          totalProgress.done = state.done;\n\n          progress.reportProgress(totalProgress);\n        }\n      });\n    }\n\n    if (promise) {\n      try {\n        return promise.await();\n      } finally {\n        if (progress) {\n          progress.reportProgressDone();\n        }\n      }\n    } else {\n      return req;\n    }\n  },\n\n  // Adds progress callbacks to a request\n  // Based on request-progress\n  _addProgressEvents: function (request) {\n    var state = {};\n\n    var emitProgress = function () {\n      request.emit('progress', state);\n    };\n\n    request\n      .on('response', function (response) {\n        state.end = undefined;\n        state.done = false;\n        state.current = 0;\n        var contentLength = response.headers['content-length'];\n        if (contentLength) {\n          state.end = Number(contentLength);\n        }\n        emitProgress();\n      })\n      .on('data', function (data) {\n        state.current += data.length;\n        emitProgress();\n      })\n      .on('end', function (data) {\n        state.done = true;\n        emitProgress();\n      });\n  },\n\n  // A synchronous wrapper around request(...) that returns the response \"body\"\n  // or throws.\n  //\n  // (This has gone through a few refactors and it might be possible\n  // to fully roll it into httpHelpers.request() at this point.)\n  getUrl: function (urlOrOptions) {\n    try {\n      var result = httpHelpers.request(urlOrOptions);\n    } catch (e) {\n      throw new files.OfflineError(e);\n    }\n\n    const response = result.response;\n    const body = result.body;\n    const href = response.request.href;\n\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      throw Error(\n        body ||\n          `Could not get ${href}; server returned [${response.statusCode}]`);\n    } else {\n      return body;\n    }\n  },\n\n  // More or less as above, except with support for multiple attempts per\n  // request and resuming on retries. This means if the connection is bad,\n  // we can sometimes complete a request, even if each individual attempt fails.\n  // We only use this for package downloads. In theory we could use it for\n  // all requests but that seems like overkill and it isn't well tested in\n  // other scenarioes.\n  getUrlWithResuming(urlOrOptions) {\n    const options = _.isObject(urlOrOptions) ? _.clone(urlOrOptions) : {\n      url: urlOrOptions,\n    };\n\n    const maxAttempts =\n      _.has(options, \"maxAttempts\")\n      ? options.maxAttempts : 10;\n\n    const retryDelaySecs =\n      _.has(options, \"retryDelaySecs\")\n      ? options.retryDelaySecs : 5;\n\n    const masterProgress = options.progress;\n    const outputStream = new ConcatStream();\n\n    function attempt(triesRemaining = maxAttempts, startAt = 0) {\n      if (startAt > 0) {\n        options.headers = {\n          ...options.headers,\n          Range: `bytes=${startAt}-`\n        };\n      }\n\n      if (masterProgress &&\n          masterProgress.addChildTask) {\n        options.progress = masterProgress.addChildTask({\n          title: masterProgress._title\n        });\n      }\n\n      try {\n        return Promise.resolve(httpHelpers.request({\n          outputStream,\n          ...options,\n        }));\n\n      } catch (e) {\n        const size = outputStream.size;\n        const useTry = size === startAt;\n        const change = size - startAt;\n\n        if (!useTry || triesRemaining > 0) {\n          if (useTry) {\n            Console.debug(`Request failed, ${triesRemaining - 1} attempts left`);\n          } else {\n            Console.debug(`Request failed after ${change} bytes, retrying`);\n          }\n\n          return new Promise(\n            resolve => setTimeout(resolve, retryDelaySecs * 1000)\n          ).then(() => attempt(triesRemaining - (useTry ? 1 : 0), size));\n        }\n\n        Console.debug(`Request failed ${maxAttempts} times: failing`);\n        return Promise.reject(new files.OfflineError(e));\n      }\n    }\n\n    const result = attempt().await();\n    const response = result.response\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      const href = response.request.href;\n      throw Error(`Could not get ${href}; server returned [${response.statusCode}]`);\n    }\n\n    // Really end the stream if we got this far.\n    outputStream.end(true);\n\n    return outputStream.getBuffer();\n  }\n});\n"]}