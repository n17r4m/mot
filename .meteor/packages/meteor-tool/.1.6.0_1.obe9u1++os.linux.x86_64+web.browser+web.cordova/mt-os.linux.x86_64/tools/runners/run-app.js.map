{"version":3,"sources":["/tools/runners/run-app.js"],"names":["module1","module","cordova","watch","require","v","CordovaBuilder","closeAllWatchers","eachline","_","Fiber","fiberHelpers","files","bundler","buildmessage","runLog","stats","Console","catalog","Profile","release","bashParse","s","search","Error","without","split","getNodeOptionsFromEnvironment","process","env","NODE_OPTIONS","AppProcess","options","self","projectContext","bundlePath","port","listenHost","rootUrl","mongoUrl","oplogUrl","mobileServerUrl","onExit","onListen","nodeOptions","nodePath","inspect","settings","testMetadata","proc","madeExitCallback","extend","prototype","start","_spawn","stdout","line","match","logAppOutput","stderr","on","code","signal","_maybeCallOnExit","err","_refreshing","log","message","arrow","stdin","stop","pid","removeAllListeners","kill","_computeEnvironment","PORT","ROOT_URL","MONGO_URL","MOBILE_DDP_URL","MOBILE_ROOT_URL","MONGO_OPLOG_URL","METEOR_SETTINGS","TEST_METADATA","JSON","stringify","BIND_IP","APP_ID","appIdentifier","HTTP_FORWARDED_COUNT","parseInt","break","METEOR_INSPECT_BRK","shellDir","getMeteorShellDirectory","mkdir_p","METEOR_SHELL_DIR","convertToOSPath","METEOR_PARENT_PID","METEOR_BAD_PARENT_PID_FOR_TEST","METEOR_PRINT_ON_LISTEN","path","NODE_PATH","join","delimiter","execPath","entryPoint","pathJoin","opts","clone","push","child_process","child","spawn","stdio","AppRunner","buildOptions","cordovaRunner","settingsFile","proxy","watchForChanges","undefined","onRunEnd","noRestartBanner","recordPackageUsage","omitPackageMapDeltaDisplayOnFirstRun","fiber","startPromise","runPromise","exitPromise","watchPromise","_promiseResolvers","_beforeStartPromise","builders","_makePromise","_fiber","run","await","name","Promise","resolve","_resolvePromise","value","_cleanUpPromises","each","outcome","makeBeforeStartPromise","_runOnce","firstRun","enableProgressDisplay","clearLog","setMode","getProjectLocalDirectory","cachedServerWatchSet","bundleApp","triedToRefreshRecently","reset","softRefreshIsopacks","preservePackageMap","messages","capture","readProjectMetadata","hasMessages","runResult","errors","watchSet","getProjectAndLocalPackagesWatchSet","wrongRelease","usingRightReleaseForApp","displayReleaseNeeded","releaseFile","displayReleaseName","prepareProjectForBuild","packageMapDelta","displayOnConsole","recordPackages","what","bundleResult","bundle","outputPath","includeNodeModules","hasCachedBundle","previousBuilders","serverWatchSet","combinedWatchSetForBundleResult","br","merge","clientWatchSet","bundleResultOrRunResult","settingsWatchSet","WatchSet","settingsMessages","title","rootPath","cwd","getSettings","canRefreshClient","packageMap","getInfo","pluginVersions","pluginVersionsFromStarManifest","starManifest","started","prepareProject","printWarningsIfNeeded","havePlatformsChangedSinceLastRun","havePluginsChangedSinceLastRun","beforeRun","appProcess","map","stopped","maybePrintLintWarnings","lintAppAndLocalPackages","warnings","formattedMessages","formatMessages","startRunTargets","serverWatcher","clientWatcher","Watcher","onChange","setupClientWatcher","isUpToDate","ret","logClientRestart","oldPromise","send","refresh","logTemporary","crashCount","crashTimer","resetCrashCount","setTimeout","logRestart","clearTimeout","wantExit","watcher","exports"],"mappings":"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","file":"tools/runners/run-app.js.map","sourcesContent":["var _ = require('underscore');\nvar Fiber = require('fibers');\nvar fiberHelpers = require('../utils/fiber-helpers.js');\nvar files = require('../fs/files.js');\nvar watch = require('../fs/watch.js');\nvar bundler = require('../isobuild/bundler.js');\nvar buildmessage = require('../utils/buildmessage.js');\nvar runLog = require('./run-log.js');\nvar stats = require('../meteor-services/stats.js');\nvar Console = require('../console/console.js').Console;\nvar catalog = require('../packaging/catalog/catalog.js');\nvar Profile = require('../tool-env/profile.js').Profile;\nvar release = require('../packaging/release.js');\nimport * as cordova from '../cordova';\nimport { CordovaBuilder } from '../cordova/builder.js';\nimport { closeAllWatchers } from \"../fs/safe-watcher.js\";\nimport { eachline } from \"../utils/eachline.js\";\n\n// Parse out s as if it were a bash command line.\nvar bashParse = function (s) {\n  if (s.search(\"\\\"\") !== -1 || s.search(\"'\") !== -1) {\n    throw new Error(\"Meteor cannot currently handle quoted NODE_OPTIONS\");\n  }\n  return _.without(s.split(/\\s+/), '');\n};\n\nvar getNodeOptionsFromEnvironment = function () {\n  return bashParse(process.env.NODE_OPTIONS || \"\");\n};\n\n///////////////////////////////////////////////////////////////////////////////\n// AppProcess\n///////////////////////////////////////////////////////////////////////////////\n\n// Given a bundle, run a program in the bundle. Report when it dies.\n//\n// Call start() to start the process. You will then eventually receive\n// a call to onExit(code, signal): code is the numeric exit code of a\n// normal exit, signal is the string signal name if killed, and if\n// both are undefined it means something went wrong in invoking the\n// program and it was logged.\n//\n// If the app successfully starts up, you will also receive onListen()\n// once the app says it's ready to receive connections.\n//\n// Call stop() at any time after start() returns to terminate the\n// process if it is running. You will get an onExit callback if this\n// resulted in the process dying. stop() is idempotent.\n//\n// Required options: bundlePath, port, rootUrl, mongoUrl, oplogUrl\n// Optional options: onExit, onListen, nodeOptions, settings\n\nvar AppProcess = function (options) {\n  var self = this;\n\n  self.projectContext = options.projectContext;\n  self.bundlePath = options.bundlePath;\n  self.port = options.port;\n  self.listenHost = options.listenHost;\n  self.rootUrl = options.rootUrl;\n  self.mongoUrl = options.mongoUrl;\n  self.oplogUrl = options.oplogUrl;\n  self.mobileServerUrl = options.mobileServerUrl;\n\n  self.onExit = options.onExit;\n  self.onListen = options.onListen;\n  self.nodeOptions = options.nodeOptions || [];\n  self.nodePath = options.nodePath || [];\n  self.inspect = options.inspect;\n  self.settings = options.settings;\n  self.testMetadata = options.testMetadata;\n\n  self.proc = null;\n  self.madeExitCallback = false;\n};\n\n_.extend(AppProcess.prototype, {\n  // Call to start the process.\n  start: function () {\n    var self = this;\n\n    if (self.proc) {\n      throw new Error(\"already started?\");\n    }\n\n    // Start the app!\n    self.proc = self._spawn();\n\n    eachline(self.proc.stdout, function (line) {\n      if (line.match(/^LISTENING\\s*$/)) {\n        // This is the child process telling us that it's ready to receive\n        // connections.  (It does this because we told it to with\n        // $METEOR_PRINT_ON_LISTEN.)\n        self.onListen && self.onListen();\n\n      } else {\n        runLog.logAppOutput(line);\n      }\n    });\n\n    eachline(self.proc.stderr, function (line) {\n      runLog.logAppOutput(line, true);\n    });\n\n    // Watch for exit and for stdio to be fully closed (so that we don't miss\n    // log lines).\n    self.proc.on('close', async function (code, signal) {\n      self._maybeCallOnExit(code, signal);\n    });\n\n    self.proc.on('error', async function (err) {\n      // if the error is the result of .send command over ipc pipe, ignore it\n      if (self._refreshing) {\n        return;\n      }\n\n      runLog.log(\"Couldn't spawn process: \" + err.message,  { arrow: true });\n\n      // node docs say that it might make both an 'error' and a\n      // 'close' callback, so we use a guard to make sure we only call\n      // onExit once.\n      self._maybeCallOnExit();\n    });\n\n    // This happens sometimes when we write a keepalive after the app\n    // is dead. If we don't register a handler, we get a top level\n    // exception and the whole app dies.\n    // http://stackoverflow.com/questions/2893458/uncatchable-errors-in-node-js\n    self.proc.stdin.on('error', function () {});\n  },\n\n  _maybeCallOnExit: function (code, signal) {\n    var self = this;\n    if (self.madeExitCallback) {\n      return;\n    }\n    self.madeExitCallback = true;\n    self.onExit && self.onExit(code, signal);\n  },\n\n  // Idempotent. Once stop() returns it is guaranteed that you will\n  // receive no more callbacks from this AppProcess.\n  stop: function () {\n    var self = this;\n\n    if (self.proc && self.proc.pid) {\n      self.proc.removeAllListeners('close');\n      self.proc.removeAllListeners('error');\n      self.proc.kill();\n    }\n    self.proc = null;\n\n    self.onListen = null;\n    self.onExit = null;\n  },\n\n  _computeEnvironment: function () {\n    var self = this;\n    var env = _.extend({}, process.env);\n\n    env.PORT = self.port;\n    env.ROOT_URL = self.rootUrl;\n    env.MONGO_URL = self.mongoUrl;\n    if (self.mobileServerUrl) {\n      env.MOBILE_DDP_URL = self.mobileServerUrl;\n      env.MOBILE_ROOT_URL = self.mobileServerUrl;\n    }\n\n    if (self.oplogUrl) {\n      env.MONGO_OPLOG_URL = self.oplogUrl;\n    }\n    if (self.settings) {\n      env.METEOR_SETTINGS = self.settings;\n    } else {\n      // Warn the developer that we are not going to use their environment var.\n      if (env.METEOR_SETTINGS) {\n        runLog.log(\n          \"WARNING: The 'METEOR_SETTINGS' environment variable is ignored \" +\n          \"when running in development (as you are doing now).  Instead, use \" +\n          \"the '--settings settings.json' option to see reactive changes \" +\n          \"when settings are changed.  For more information, see the \" +\n          \"documentation for 'Meteor.settings': \" +\n          \"https://docs.meteor.com/api/core.html#Meteor-settings\" +\n          \"\\n\");\n      }\n\n      // To provide a consistent, reactive experience in development, do\n      // not use settings provided via the environment variable.\n      delete env.METEOR_SETTINGS;\n    }\n    if (self.testMetadata) {\n      env.TEST_METADATA = JSON.stringify(self.testMetadata);\n    } else {\n      delete env.TEST_METADATA;\n    }\n    if (self.listenHost) {\n      env.BIND_IP = self.listenHost;\n    } else {\n      delete env.BIND_IP;\n    }\n    env.APP_ID = self.projectContext.appIdentifier;\n\n    // We run the server behind our own proxy, so we need to increment\n    // the HTTP forwarded count.\n    env.HTTP_FORWARDED_COUNT =\n      \"\" + ((parseInt(process.env['HTTP_FORWARDED_COUNT']) || 0) + 1);\n\n    if (self.inspect &&\n        self.inspect.break) {\n      env.METEOR_INSPECT_BRK = self.inspect.port;\n    } else {\n      delete env.METEOR_INSPECT_BRK;\n    }\n\n    var shellDir = self.projectContext.getMeteorShellDirectory();\n    files.mkdir_p(shellDir);\n\n    // We need to convert to OS path here because the running app doesn't\n    // have access to path translation functions\n    env.METEOR_SHELL_DIR = files.convertToOSPath(shellDir);\n\n    env.METEOR_PARENT_PID =\n      process.env.METEOR_BAD_PARENT_PID_FOR_TEST ? \"foobar\" : process.pid;\n\n    env.METEOR_PRINT_ON_LISTEN = 'true';\n\n    // use node's path module and not 'files.js' because NODE_PATH is an\n    // environment variable passed to an external process and needs to be\n    // constructed in the OS-style.\n    var path = require('path');\n    env.NODE_PATH =\n      self.nodePath.join(path.delimiter);\n\n    return env;\n  },\n\n  // Spawn the server process and return the handle from child_process.spawn.\n  _spawn: function () {\n    var self = this;\n\n    // Path conversions\n    var nodePath = process.execPath; // This path is an OS path already\n    var entryPoint = files.convertToOSPath(\n      files.pathJoin(self.bundlePath, 'main.js'));\n\n    // Setting options\n    var opts = _.clone(self.nodeOptions);\n\n    if (self.inspect) {\n      // Always use --inspect rather than --inspect-brk, even when\n      // self.inspect.break is true, because --inspect-brk stops at the\n      // very first instruction executed by the child process, which is\n      // too early to set any meaningful breakpoints. Instead, we want to\n      // stop just after server code has loaded but before it begins to\n      // execute. See _computeEnvironment for logic that sets\n      // env.METEOR_INSPECT_BRK in that case.\n      opts.push(\"--inspect=\" + self.inspect.port);\n    }\n\n    opts.push(entryPoint);\n\n    // Call node\n    var child_process = require('child_process');\n    // setup the 'ipc' pipe if further communication between app and proxy is\n    // expected\n    var child = child_process.spawn(nodePath, opts, {\n      env: self._computeEnvironment(),\n      stdio: ['pipe', 'pipe', 'pipe', 'ipc'],\n    });\n\n    return child;\n  }\n});\n\n///////////////////////////////////////////////////////////////////////////////\n// AppRunner\n///////////////////////////////////////////////////////////////////////////////\n\n// Given an app, bundle and run the app. If the app's source changes,\n// kill, rebundle, and rerun it. If the app dies, restart it, unless\n// it dies repeatedly immediately after being started, in which case\n// wait for source changes to restart.\n//\n// Communicates with a Proxy to tell it when the app is up,\n// temporarily down, or crashing.\n//\n// Options include:\n//\n// - onRunEnd(result): If provided, called after each run of the program (or\n//   attempted run, if, say, bundling fails). Blocks restarting until it\n//   returns. See below for the format of 'result'. Return truthy to continue;\n//   return falsey to give up (without logging any more status messages). Do not\n//   call stop() from onRunEnd as that would necessarily deadlock.\n//\n// - watchForChanges: If true, the default, then (a) the program will\n//   be killed and restarted if its source files change; (b) if\n//   something goes really wrong (bundling fails, the program crashes\n//   constantly) such that we give up, we will start trying again if\n//   the source files change. If false, then we don't do (a) and if\n//   (b) happens we just give up permanently.\n//\n// - noRestartBanner: Set to true to skip the banner that is normally\n//   printed after each restart of the app once it is ready to listen\n//   for connections.\n//\n// - Other options: port, mongoUrl, oplogUrl, buildOptions, rootUrl,\n//   settingsFile, program, proxy, recordPackageUsage\n//\n// To use, construct an instance of AppRunner, and then call start() to start it\n// running. To stop it, either return false from onRunEnd, or call stop().  (But\n// don't call stop() from inside onRunEnd: that causes a deadlock.)\n//\n// The 'result' argument to onRunEnd is an object with keys:\n//\n// - outcome: the reason the run ended. One of:\n//\n//   - 'terminated': the process exited. Additionally, a 'code'\n//     attribute will be set of the process exited on its own accord,\n//     a 'signal' attribute will be set if the process was killed on a\n//     signal, or neither will be set if the process could not be\n//     spawned (spawn call failed, or no such program in bundle) -- in\n//     this last case an explanation will have been written to the run\n//     log, and you may assume that it will take more than source code\n//     changes to fix the problem.\n//\n//   - 'bundle-fail': bundling failed.\n//\n//   - 'changed': watchForChanges was true and a source file changed.\n//\n//   - 'wrong-release': the release that this app targets does not\n//     match the currently running version of Meteor (eg, the user\n//     typed 'meteor update' in another window). An 'displayReleaseNeeded'\n//     attribute will be present giving the app's release name.\n//\n//   - 'conflicting-versions': the constraint solver could not find a set of\n//     package versions to use that would satisfy the constraints of\n//     .meteor/versions and .meteor/packages. This could be caused by conflicts\n//     in .meteor/versions, conflicts in .meteor/packages, and/or inconsistent\n//     changes to the dependencies in local packages.\n//\n//   - 'stopped': stop() was called while a run was in progress.\n//\n// - errors: for 'bundle-fail', the buildmessage messages object corresponding\n//      to the error\n//\n// - watchSet: for runs in which there's a reason to wait for file changes\n//      ('bundle-fail' and 'terminated'), the WatchSet to wait on.\nvar AppRunner = function (options) {\n  var self = this;\n\n  self.projectContext = options.projectContext;\n\n  // note: run-all.js updates port directly\n  self.port = options.port;\n  self.listenHost = options.listenHost;\n  self.mongoUrl = options.mongoUrl;\n  self.oplogUrl = options.oplogUrl;\n  self.buildOptions = options.buildOptions;\n  self.rootUrl = options.rootUrl;\n  self.mobileServerUrl = options.mobileServerUrl;\n  self.cordovaRunner = options.cordovaRunner;\n  self.settingsFile = options.settingsFile;\n  self.testMetadata = options.testMetadata;\n  self.inspect = options.inspect;\n  self.proxy = options.proxy;\n  self.watchForChanges =\n    options.watchForChanges === undefined ? true : options.watchForChanges;\n  self.onRunEnd = options.onRunEnd;\n  self.noRestartBanner = options.noRestartBanner;\n  self.recordPackageUsage =\n    options.recordPackageUsage === undefined ? true : options.recordPackageUsage;\n  self.omitPackageMapDeltaDisplayOnFirstRun =\n    options.omitPackageMapDeltaDisplayOnFirstRun;\n\n  self.fiber = null;\n  self.startPromise = null;\n  self.runPromise = null;\n  self.exitPromise = null;\n  self.watchPromise = null;\n  self._promiseResolvers = {};\n\n  // If this promise is set with self.makeBeforeStartPromise, then for the first\n  // run, we will wait on it just before self.appProcess.start() is called.\n  self._beforeStartPromise = null;\n  // A hacky state variable that indicates that the proxy process (this process)\n  // is communicating to the app process over ipc. If an error in communication\n  // occurs, we can distinguish it in a callback handling the 'error' event.\n  self._refreshing = false;\n\n  // Builders saved across rebuilds, so that targets can be re-written in\n  // place instead of created again from scratch.\n  self.builders = {};\n};\n\n_.extend(AppRunner.prototype, {\n  // Start the app running, and restart it as necessary. Returns\n  // immediately.\n  start: function () {\n    var self = this;\n\n    if (self.fiber) {\n      throw new Error(\"already started?\");\n    }\n\n    self.startPromise = self._makePromise(\"start\");\n\n    self.fiber = Fiber(function () {\n      self._fiber();\n    });\n    self.fiber.run();\n\n    self.startPromise.await();\n    self.startPromise = null;\n  },\n\n  _makePromise: function (name) {\n    var self = this;\n    return new Promise(function (resolve) {\n      self._promiseResolvers[name] = resolve;\n    });\n  },\n\n  _resolvePromise: function (name, value) {\n    var resolve = this._promiseResolvers[name];\n    if (resolve) {\n      this._promiseResolvers[name] = null;\n      resolve(value);\n    }\n  },\n\n  _cleanUpPromises: function () {\n    if (this._promiseResolvers) {\n      _.each(this._promiseResolvers, function (resolve) {\n        resolve && resolve();\n      });\n      this._promiseResolvers = null;\n    }\n  },\n\n  // Shut down the app. stop() will block until the app is shut\n  // down. This may involve waiting for bundling to\n  // finish. Idempotent, however only one thread may be in stop() at a\n  // time.\n  stop: function () {\n    var self = this;\n\n    if (! self.fiber) {\n      // nothing to do\n      return;\n    }\n\n    if (self.exitPromise) {\n      throw new Error(\"another fiber already stopping?\");\n    }\n\n    // The existence of this promise makes the fiber break out of its loop.\n    self.exitPromise = self._makePromise(\"exit\");\n\n    self._resolvePromise(\"run\", { outcome: 'stopped' });\n    self._resolvePromise(\"watch\");\n\n    if (self._beforeStartPromise) {\n      // If we stopped before mongod started (eg, due to mongod startup\n      // failure), unblock the runner fiber from waiting for mongod to start.\n      self._resolvePromise(\"beforeStart\", true);\n    }\n\n    self.exitPromise.await();\n    self.exitPromise = null;\n  },\n\n  // Returns a function that can be called to resolve _beforeStartPromise.\n  makeBeforeStartPromise: function () {\n    if (this._beforeStartPromise) {\n      throw new Error(\"makeBeforeStartPromise called twice?\");\n    }\n    this._beforeStartPromise = this._makePromise(\"beforeStart\");\n    return this._promiseResolvers[\"beforeStart\"];\n  },\n\n  // Run the program once, wait for it to exit, and then return. The\n  // return value is same as onRunEnd.\n  _runOnce: function (options) {\n    var self = this;\n    options = options || {};\n    var firstRun = options.firstRun;\n\n    Console.enableProgressDisplay(true);\n\n    runLog.clearLog();\n    self.proxy.setMode(\"hold\");\n\n    // Bundle up the app\n    var bundlePath = self.projectContext.getProjectLocalDirectory('build');\n\n    // Cache the server target because the server will not change inside\n    // a single invocation of _runOnce().\n    var cachedServerWatchSet;\n\n    var bundleApp = function () {\n      if (! firstRun) {\n        // If the build fails in a way that could be fixed by a refresh, allow\n        // it even if we refreshed previously, since that might have been a\n        // little while ago.\n        catalog.triedToRefreshRecently = false;\n\n        // If this isn't the first time we've run, we need to reset the project\n        // context since everything we have cached may have changed.\n        // XXX We can try to be a little less conservative here:\n        // - Don't re-build the whole local catalog if we know which local\n        //   packages have changed.  (This one might be a little trickier due\n        //   to how the WatchSets are laid out.  Might be possible to avoid\n        //   re-building the local catalog at all if packages didn't change\n        //   at all, though.)\n        self.projectContext.reset({}, {\n          // Don't forget all Isopack objects; just make sure to check that they\n          // are up to date.\n          softRefreshIsopacks: true,\n          // Don't forget the package map we calculated last time, even if we\n          // didn't write it to disk (because, eg, we're not running with a\n          // release that matches the app's release).  While we will still check\n          // our constraints, we will use the map we calculated last time as the\n          // previous solution (not what's on disk). Package deltas should be\n          // shown from the previous solution.\n          preservePackageMap: true\n        });\n        var messages = buildmessage.capture(function () {\n          self.projectContext.readProjectMetadata();\n        });\n        if (messages.hasMessages()) {\n          return {\n            runResult: {\n              outcome: 'bundle-fail',\n              errors: messages,\n              watchSet: self.projectContext.getProjectAndLocalPackagesWatchSet()\n            }\n          };\n        }\n      }\n\n      // Check to make sure we're running the right version of Meteor.\n      var wrongRelease = ! release.usingRightReleaseForApp(self.projectContext);\n      if (wrongRelease) {\n        return {\n          runResult: {\n            outcome: 'wrong-release',\n            displayReleaseNeeded:\n              self.projectContext.releaseFile.displayReleaseName\n          }\n        };\n      }\n\n      messages = buildmessage.capture(function () {\n        self.projectContext.prepareProjectForBuild();\n      });\n      if (messages.hasMessages()) {\n        return {\n          runResult: {\n            outcome: 'bundle-fail',\n            errors: messages,\n            watchSet: self.projectContext.getProjectAndLocalPackagesWatchSet()\n          }\n        };\n      }\n\n      // Show package changes... unless it's the first time in test-packages.\n      if (!(self.omitPackageMapDeltaDisplayOnFirstRun && firstRun)) {\n        self.projectContext.packageMapDelta.displayOnConsole();\n      }\n\n      if (self.recordPackageUsage) {\n        stats.recordPackages({\n          what: \"sdk.run\",\n          projectContext: self.projectContext\n        });\n      }\n\n      var bundleResult = Profile.run((firstRun?\"B\":\"Reb\")+\"uild App\", () => {\n        var bundleResult = bundler.bundle({\n          projectContext: self.projectContext,\n          outputPath: bundlePath,\n          includeNodeModules: \"symlink\",\n          buildOptions: self.buildOptions,\n          hasCachedBundle: !! cachedServerWatchSet,\n          previousBuilders: self.builders\n        });\n\n        // save new builders with their caches\n        self.builders = bundleResult.builders;\n\n        return bundleResult;\n      });\n\n      // Keep the server watch set from the initial bundle, because subsequent\n      // bundles will not contain a server target.\n      if (cachedServerWatchSet) {\n        bundleResult.serverWatchSet = cachedServerWatchSet;\n      } else {\n        cachedServerWatchSet = bundleResult.serverWatchSet;\n      }\n\n      if (bundleResult.errors) {\n        return {\n          runResult: {\n            outcome: 'bundle-fail',\n            errors: bundleResult.errors,\n            watchSet: combinedWatchSetForBundleResult(bundleResult)\n          }\n        };\n      } else {\n        return { bundleResult: bundleResult };\n      }\n    };\n\n    var combinedWatchSetForBundleResult = function (br) {\n      var watchSet = br.serverWatchSet.clone();\n      watchSet.merge(br.clientWatchSet);\n      return watchSet;\n    };\n\n    var bundleResult;\n    var bundleResultOrRunResult = bundleApp();\n    if (bundleResultOrRunResult.runResult) {\n      return bundleResultOrRunResult.runResult;\n    }\n    bundleResult = bundleResultOrRunResult.bundleResult;\n\n    firstRun = false;\n\n    // Read the settings file, if any\n    var settings = null;\n    var settingsWatchSet = new watch.WatchSet;\n    var settingsMessages = buildmessage.capture({\n      title: \"preparing to run\",\n      rootPath: process.cwd()\n    }, function () {\n      if (self.settingsFile) {\n        settings = files.getSettings(self.settingsFile, settingsWatchSet);\n      }\n    });\n    if (settingsMessages.hasMessages()) {\n      return {\n        outcome: 'bundle-fail',\n        errors: settingsMessages,\n        watchSet: settingsWatchSet\n      };\n    }\n\n    var serverWatchSet = bundleResult.serverWatchSet;\n    serverWatchSet.merge(settingsWatchSet);\n\n    // We only can refresh the client without restarting the server if the\n    // client contains the 'autoupdate' package.\n    var canRefreshClient = self.projectContext.packageMap &&\n          self.projectContext.packageMap.getInfo('autoupdate');\n\n    if (! canRefreshClient) {\n      // Restart server on client changes if we can't refresh the client.\n      serverWatchSet = combinedWatchSetForBundleResult(bundleResult);\n    }\n\n    const cordovaRunner = self.cordovaRunner;\n    if (cordovaRunner) {\n      const pluginVersions =\n        cordova.pluginVersionsFromStarManifest(bundleResult.starManifest);\n\n      if (!cordovaRunner.started) {\n        const { settingsFile, mobileServerUrl } = self;\n        const messages = buildmessage.capture(() => {\n          cordovaRunner.prepareProject(bundlePath, pluginVersions,\n            { settingsFile, mobileServerUrl });\n        });\n\n        if (messages.hasMessages()) {\n          return {\n            outcome: 'bundle-fail',\n            errors: messages,\n            watchSet: combinedWatchSetForBundleResult(bundleResult)\n          };\n        }\n        cordovaRunner.printWarningsIfNeeded();\n      } else {\n        // If the set of Cordova platforms or plugins changes from one run\n        // to the next, we just exit, because we don't yet have a way to,\n        // for example, get the new plugins to the mobile clients or stop a\n        // running client on a platform that has been removed.\n\n        if (cordovaRunner.havePlatformsChangedSinceLastRun()) {\n          return { outcome: 'outdated-cordova-platforms' };\n        }\n\n        if (cordovaRunner.havePluginsChangedSinceLastRun(pluginVersions)) {\n          return { outcome: 'outdated-cordova-plugins' };\n        }\n      }\n    }\n\n    // Atomically (1) see if we've been stop()'d, (2) if not, create a\n    // promise that can be used to stop() us once we start running.\n    if (self.exitPromise) {\n      return { outcome: 'stopped' };\n    }\n\n    if (self.runPromise) {\n      throw new Error(\"already have promise?\");\n    }\n\n    var runPromise = self.runPromise = self._makePromise(\"run\");\n\n    // Run the program\n    options.beforeRun && options.beforeRun();\n    var appProcess = new AppProcess({\n      projectContext: self.projectContext,\n      bundlePath: bundlePath,\n      port: self.port,\n      listenHost: self.listenHost,\n      rootUrl: self.rootUrl,\n      mongoUrl: self.mongoUrl,\n      oplogUrl: self.oplogUrl,\n      mobileServerUrl: self.mobileServerUrl,\n      onExit: function (code, signal) {\n        self._resolvePromise(\"run\", {\n          outcome: 'terminated',\n          code: code,\n          signal: signal,\n          watchSet: combinedWatchSetForBundleResult(bundleResult)\n        });\n      },\n      inspect: self.inspect,\n      onListen: function () {\n        self.proxy.setMode(\"proxy\");\n        options.onListen && options.onListen();\n        self._resolvePromise(\"start\");\n      },\n      nodeOptions: getNodeOptionsFromEnvironment(),\n      nodePath: _.map(bundleResult.nodePath, files.convertToOSPath),\n      settings: settings,\n      testMetadata: self.testMetadata,\n    });\n\n    if (options.firstRun && self._beforeStartPromise) {\n      var stopped = self._beforeStartPromise.await();\n      if (stopped) {\n        return true;\n      }\n    }\n\n    appProcess.start();\n    function maybePrintLintWarnings(bundleResult) {\n      if (! (self.projectContext.lintAppAndLocalPackages &&\n             bundleResult.warnings)) {\n        return;\n      }\n      if (bundleResult.warnings.hasMessages()) {\n        const formattedMessages = bundleResult.warnings.formatMessages();\n        runLog.log(\n          `Linted your app.\\n\\n${ formattedMessages }`,\n          { arrow: true });\n      } else {\n        runLog.log('Linted your app. No linting errors.',\n                   { arrow: true });\n      }\n    }\n    maybePrintLintWarnings(bundleResult);\n\n    if (cordovaRunner && !cordovaRunner.started) {\n      cordovaRunner.startRunTargets();\n    }\n\n    // Start watching for changes for files if requested. There's no\n    // hurry to do this, since clientWatchSet contains a snapshot of the\n    // state of the world at the time of bundling, in the form of\n    // hashes and lists of matching files in each directory.\n    var serverWatcher;\n    var clientWatcher;\n\n    if (self.watchForChanges) {\n      serverWatcher = new watch.Watcher({\n        watchSet: serverWatchSet,\n        onChange: function () {\n          self._resolvePromise(\"run\", {\n            outcome: 'changed'\n          });\n        }\n      });\n    }\n\n    var setupClientWatcher = function () {\n      clientWatcher && clientWatcher.stop();\n      clientWatcher = new watch.Watcher({\n         watchSet: bundleResult.clientWatchSet,\n         onChange: function () {\n          var outcome = watch.isUpToDate(serverWatchSet)\n                      ? 'changed-refreshable' // only a client asset has changed\n                      : 'changed'; // both a client and server asset changed\n          self._resolvePromise('run', { outcome: outcome });\n         }\n      });\n    };\n    if (self.watchForChanges && canRefreshClient) {\n      setupClientWatcher();\n    }\n\n    Console.enableProgressDisplay(false);\n\n    // Wait for either the process to exit, or (if watchForChanges) a\n    // source file to change. Or, for stop() to be called.\n    var ret = runPromise.await();\n\n    try {\n      while (ret.outcome === 'changed-refreshable') {\n        if (! canRefreshClient) {\n          throw Error(\"Can't refresh client?\");\n        }\n\n        // We stay in this loop as long as only refreshable assets have changed.\n        // When ret.refreshable becomes false, we restart the server.\n        bundleResultOrRunResult = bundleApp();\n        if (bundleResultOrRunResult.runResult) {\n          return bundleResultOrRunResult.runResult;\n        }\n        bundleResult = bundleResultOrRunResult.bundleResult;\n\n        maybePrintLintWarnings(bundleResult);\n\n        runLog.logClientRestart();\n\n        var oldPromise = self.runPromise = self._makePromise(\"run\");\n\n        // Notify the server that new client assets have been added to the\n        // build.\n        self._refreshing = true;\n        // ChildProcess.prototype.send used to be synchronous, but is now\n        // asynchronous: https://github.com/nodejs/node/pull/2620\n        appProcess.proc.send({\n          refresh: 'client'\n        }, err => {\n          self._refreshing = false;\n          if (err) throw err;\n        });\n\n        // Establish a watcher on the new files.\n        setupClientWatcher();\n\n        // Wait until another file changes.\n        ret = oldPromise.await();\n      }\n    } finally {\n      self.runPromise = null;\n\n      if (ret.outcome === 'changed') {\n        runLog.logTemporary(\"=> Server modified -- restarting...\");\n      }\n\n      self.proxy.setMode(\"hold\");\n      appProcess.stop();\n\n      serverWatcher && serverWatcher.stop();\n      clientWatcher && clientWatcher.stop();\n    }\n\n    return ret;\n  },\n\n  _fiber: function () {\n    var self = this;\n\n    var crashCount = 0;\n    var crashTimer = null;\n    var firstRun = true;\n\n    while (true) {\n\n      var resetCrashCount = function () {\n        crashTimer = setTimeout(function () {\n          crashCount = 0;\n        }, 8000);\n      };\n\n      var runResult = self._runOnce({\n        onListen: function () {\n          if (! self.noRestartBanner && ! firstRun) {\n            runLog.logRestart();\n            Console.enableProgressDisplay(false);\n          }\n        },\n        beforeRun: resetCrashCount,\n        firstRun: firstRun\n      });\n      firstRun = false;\n\n      clearTimeout(crashTimer);\n      if (runResult.outcome !== \"terminated\") {\n        crashCount = 0;\n      }\n\n      var wantExit = self.onRunEnd ? !self.onRunEnd(runResult) : false;\n      if (wantExit || self.exitPromise || runResult.outcome === \"stopped\") {\n        break;\n      }\n\n      if (runResult.outcome === \"wrong-release\" ||\n          runResult.outcome === \"conflicting-versions\") {\n        // Since the only implementation of onRunEnd sets wantExit on these\n        // outcomes, we will never get here currently. Moreover, it's not\n        // actually possible for us to handle these cases correctly, because our\n        // contract says that we should wait for changes, but runResult doesn't\n        // actually contain a watchset. Oops. Just throw an exception for now.\n        throw new Error(\"can't handle outcome \" + runResult.outcome);\n      }\n\n      else if (runResult.outcome === \"bundle-fail\") {\n        runLog.log(\"Errors prevented startup:\\n\\n\" +\n                        runResult.errors.formatMessages(),  { arrow: true });\n        if (self.watchForChanges) {\n          runLog.log(\"Your application has errors. \" +\n                     \"Waiting for file change.\",  { arrow: true });\n          Console.enableProgressDisplay(false);\n        }\n      }\n\n      else if (runResult.outcome === \"changed\") {\n        continue;\n      } else if (runResult.outcome === \"terminated\") {\n        if (runResult.signal) {\n          runLog.log('Exited from signal: ' + runResult.signal, { arrow: true });\n        } else if (runResult.code !== undefined) {\n          runLog.log('Exited with code: ' + runResult.code, { arrow: true });\n        } else {\n          // explanation should already have been logged\n        }\n\n        crashCount ++;\n        if (crashCount < 3) {\n          continue;\n        }\n\n        if (self.watchForChanges) {\n          runLog.log(\"Your application is crashing. \" +\n                     \"Waiting for file change.\",\n                     { arrow: true });\n          Console.enableProgressDisplay(false);\n        }\n      }\n\n      else {\n        throw new Error(\"unknown run outcome?\");\n      }\n\n      if (self.watchForChanges) {\n        self.watchPromise = self._makePromise(\"watch\");\n\n        if (!runResult.watchSet) {\n          throw Error(\"watching for changes with no watchSet?\");\n        }\n        // XXX reference to watcher is lost later?\n        var watcher = new watch.Watcher({\n          watchSet: runResult.watchSet,\n          onChange: function () {\n            self._resolvePromise(\"watch\");\n          }\n        });\n        self.proxy.setMode(\"errorpage\");\n        // If onChange wasn't called synchronously (clearing watchPromise), wait\n        // on it.\n        self.watchPromise && self.watchPromise.await();\n        // While we were waiting, did somebody stop() us?\n        if (self.exitPromise) {\n          break;\n        }\n        runLog.log(\"Modified -- restarting.\",  { arrow: true });\n        Console.enableProgressDisplay(true);\n        continue;\n      }\n\n      break;\n    }\n\n    // Allow the process to exit normally, since optimistic file watchers\n    // may be keeping the event loop busy.\n    closeAllWatchers();\n\n    // Giving up for good.\n    self._cleanUpPromises();\n\n    self.fiber = null;\n  }\n});\n\n///////////////////////////////////////////////////////////////////////////////\n\nexports.AppRunner = AppRunner;\n"]}