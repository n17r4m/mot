{"changed":true,"filter":false,"title":"DataBag.py","tooltip":"/util/DataBag.py","value":"#! /usr/bin/env python\n\"\"\"\nStorage for detection and tracking information.\n\nCHANGELOG:\n    \n    v17.6.26  Reworked the database migration system\n              Moved out common queries to Query.py\n    v17.6.8   Added particle categories (bubble, bitumen, etc)\n\nUSING: \n\n    As a command line utility:\n    \n        $ DataBag.py file.db query \"SOME sql=true QUERY\"\n        $ DataBag.py file.db repl\n        $ DataBag.py \":memory:\" repl\n        $ DataBag.py newfile.db import import.csv\n        $ DataBag.py 1file.db compare 2file.csv\n    \n    As a module:\n    \n        from DataBag import DataBag\n        bag = DataBag(\"../data/file.db\")\n        bag = DataBag.fromArg(existingBagOrFilePathToDB)\n        \n        \n        \n\nAuthor: Martin Humphreys\n\"\"\"\n\nfrom argparse import ArgumentParser\nimport numpy as np\nimport os\nimport re\nimport sys\nimport sqlite3\nimport json\nimport png\nimport StringIO\nimport readline\nimport itertools\nimport time\n\n\nclass DataBag(object):\n    \n    @staticmethod\n    def fromArg(bag):\n        if isinstance(bag, DataBag):\n            return bag\n        if isinstance(bag, (str, unicode)):\n            if not os.path.isfile(bag):\n                raise OSError(2, 'No such data bag file', bag)\n            else:\n                return DataBag(bag)\n        raise TypeError('Invalid bag.')\n    \n    def __init__(self, db_file = \":memory:\", verbose = False):\n        \n        self.verbose = verbose\n        self.name = db_file\n        self.db = sqlite3.connect(db_file, isolation_level=\"DEFERRED\")\n        self.db.enable_load_extension(True)\n        self.db.load_extension(os.path.dirname(os.path.realpath(__file__)) + \"/libsqlitefunctions.so\")\n        \n        self.say(\"Connected to database\", db_file)\n        self.initDB()\n    \n    def __repr__(self):\n        return self.name.split('/')[-1]\n\n    def say(self, *args):\n        if self.verbose:\n            print(args)\n    \n\n    def repl(self):\n        # Read Evaluate Print Loop (REPL)\n        while True:\n            cmd = raw_input(\"sql> \")\n            try:\n                c = self.db.cursor()\n                c.execute(cmd.strip())\n                if cmd.lstrip().upper().startswith(\"SELECT\"):\n                    print c.fetchall()\n                self.db.commit()\n            except sqlite3.Error, e:\n               print \"An error occurred:\", e.args[0]\n    \n    def cursor(self):\n        # for doing some raw SQL\n        return self.db.cursor()\n    \n    def commit(self):\n        # for doing some raw SQL\n        return self.db.commit()\n    \n    def query(self, query):\n        # Execute a string query\n        # Access through self.cursor() when needing to escape arguments.\n        c = self.db.cursor()\n        c.execute(query)\n        res = c.fetchall()\n        return res\n    \n    def tryQuery(self, query):\n        try:\n            return self.query(query)\n        except: \n            return None\n    \n    \n\n    def queryJSON(self, query):\n        # Same as self.query but returns a JSON formatting string.\n        return json.dumps(self.query(query))\n    \n    def initDB(self):\n        # Make sure tables and columns are as they should be.\n        rev = self.revision()\n        if rev is 0: self.migration_0()\n        if rev is 1: self.migration_1()\n        if rev is 2: self.migration_2()\n        self.say(\"Database ready\")\n\n    \n    def revision(self):\n        c = self.db.cursor()\n        rev = 0\n        try:\n            c.execute(\"SELECT value FROM meta where name='revision'\")\n            rev = int(c.fetchone()[0])\n        except: pass\n        self.say(\"BataBag revision\", rev)\n        return rev\n    \n    def migration_0(self):\n        self.say(\"Migrating to revision\", 1)\n        c = self.cursor()\n        if not self.tableExists(\"frames\"):    c.execute(\"CREATE TABLE frames (frame INTEGER PRIMARY KEY, bitmap BLOB)\")\n        if not self.tableExists(\"assoc\"):     c.execute(\"CREATE TABLE assoc (frame INTEGER, particle INTEGER, x REAL, y REAL)\")\n        if not self.tableExists(\"particles\"): c.execute(\"CREATE TABLE particles (id INTEGER PRIMARY KEY, area REAL, intensity REAL, perimeter REAL)\")\n        if not self.tableExists(\"meta\"):\n            c.execute(\"CREATE TABLE meta (name TEXT PRIMARY KEY, value TEXT)\")\n            c.execute(\"INSERT INTO meta (name, value) VALUES ('revision', '1')\")\n        self.commit()\n        self.migration_1()\n    \n    def migration_1(self):\n        self.say(\"Migrating to revision\", 2)\n        if not self.tableExists(\"categories\"):\n            c = self.cursor()\n            c.execute(\"CREATE TABLE categories (id INTEGER PRIMARY KEY, name TEXT)\")\n            c.execute(\"INSERT INTO categories (id, name) VALUES (0, 'undefined')\")\n            c.execute(\"INSERT INTO categories (id, name) VALUES (1, 'unknown')\")\n            c.execute(\"INSERT INTO categories (id, name) VALUES (2, 'bitumen')\")\n            c.execute(\"INSERT INTO categories (id, name) VALUES (3, 'sand')\")\n            c.execute(\"INSERT INTO categories (id, name) VALUES (4, 'bubble')\")\n            self.commit()\n        \n        c.execute(\"ALTER TABLE particles ADD COLUMN radius REAL DEFAULT 0\")\n        c.execute(\"ALTER TABLE particles ADD COLUMN category INTEGER DEFAULT 0\")\n        \n        self.commit()\n        \n        self.tryQuery(\"CREATE INDEX Idx1 on particles (area, intensity, perimeter)\")\n        self.tryQuery(\"CREATE INDEX Idx2 on particles (frame, category)\") \n        self.tryQuery(\"CREATE INDEX Idx3 on assoc (frame, particle)\")\n        \n        c.execute(\"UPDATE meta SET value='2' WHERE name='revision'\");\n        self.commit()\n    \n    def migration_2(self):\n        self.say(\"Migrating to revision\", 3)\n        c = self.cursor()\n        c.execute(\"ALTER TABLE assoc ADD COLUMN scale REAL\")\n        c.execute(\"ALTER TABLE assoc ADD COLUMN crop BLOB\")\n        c.execute(\"UPDATE meta SET value='3' WHERE name='revision'\");\n        self.commit()\n    \n    def tableExists(self, table):\n        c = self.cursor()\n        c.execute(\"SELECT count(*) FROM sqlite_master WHERE type='table' AND name=?\", (table,));\n        return c.fetchone()[0] is 1\n    \n    def categoryFor(self, category):\n        c = self.cursor()\n        c.execute(\"SELECT id FROM categories WHERE name = ?\", (category))\n        id = c.fetchone()\n        if id is None: return 0\n        return id[0]\n        \n    def batchInsertFrame(self, props):\n        number = props.get(\"number\", 0)\n        bitmap = props.get(\"bitmap\", None)\n        c = self.db.cursor()\n        c.execute(\"SELECT frame FROM frames WHERE frame = ?\", (number,))\n        if len(c.fetchall()) == 0:\n            if bitmap is None:\n                c.execute(\"INSERT INTO frames (frame) VALUES (?)\", (number,))\n            else:\n                c.execute(\"INSERT INTO frames (frame, bitmap) VALUES (?, ?)\", (number, self.toPng(bitmap)))\n    \n    def crop(self, frame, particle):\n        \n    \n    def insertFrame(self, props):\n        self.batchInsertFrame(props)\n        self.commit()\n    \n    def batchInsertParticle(self, props):\n        id = props.get(\"id\", None)\n        area = props.get(\"area\", 0)\n        perimeter = props.get(\"perimeter\", 0)\n        intensity = props.get(\"intensity\", 0)\n        radius = props.get(\"radius\", 0)\n        category = props.get(\"category\", 0)\n        \n        \n        c = self.cursor()\n        if id is None:\n            c.execute(\"INSERT INTO particles (area, intensity, perimeter, radius, category) VALUES (?, ?, ?, ?, ?)\", (area, intensity, perimeter, radius, category))\n        else:\n            c.execute(\"INSERT INTO particles (id, area, intensity, perimeter, radius, category) VALUES (?, ?, ?, ?, ?, ?)\", (id, area, intensity, perimeter, radius, category))\n        return c.lastrowid\n\n    def insertParticle(self, props):\n        lastrowid = self.batchInsertParticle(props)\n        self.commit()\n        return lastrowid\n    \n    def batchInsertAssoc(self, props):\n        frame = props.get(\"frame\", 0)\n        particle = props.get(\"particle\", 0)\n        x = props.get(\"x\", 0)\n        y = props.get(\"y\", 0)\n        c = self.cursor()\n        c.execute(\"INSERT INTO assoc (frame, particle, x, y) VALUES (?, ?, ?, ?)\", (frame, particle, x, y))\n\n    def insertAssoc(self, frame, particle, x, y):\n        self.batchInsertAssoc(frame, particle, x, y)\n        self.commit()\n\n\n    def insertTrace(self, props, points):\n        \n        frame = props.get(\"frame\", 1)\n        area = props.get(\"area\", 1)\n        intensity = props.get(\"intensity\", 0)\n        perimeter = props.get(\"perimeter\", 0)\n        width = props.get(\"radius\", 0)\n        category = props.get(\"category\", 0)\n        \n        samples = points.shape[0]\n        if samples > 0:\n            particle = self.batchInsertParticle(props)\n            for pair in points:\n                props.set(\"frame\", frame)\n                props.set(\"particle\", particle)\n                props.set(\"x\", pair[0])\n                props.set(\"y\", pair[1])\n                self.batchInsertFrame(frame)\n                self.batchInsertAssoc(frame, pId, pair[0], pair[1])\n                frame += 1\n        self.commit()\n    \n    def particlesInFrame(self, frame, category = None):\n        c = self.cursor()\n        if category is None:\n            c.execute(\"SELECT id, area, intensity, category, x, y FROM assoc LEFT JOIN particles ON assoc.particle = particles.id WHERE frame = ?\", (frame,))\n        else:    \n            c.execute(\"SELECT id, area, intensity, category, x, y FROM assoc LEFT JOIN particles ON assoc.particle = particles.id WHERE frame = ? and category = ?\", (frame, category))\n        return np.array(c.fetchall())\n    \n    def particlePoints(self, particle):\n        c = self.cursor()\n        c.execute(\"SELECT x, y FROM assoc WHERE particle = ?\", (particle,))\n        return np.array(c.fetchall())\n    \n    def particleVelocities(self, particle):\n        points = self.particlePoints(particle)\n        return points[1:] - points[:-1] \n    \n    def particleMeanVelocity(self, particle):\n        return np.mean(self.particleVelocities(particle), axis=0)\n    \n    def frameMeanVelocity(self, frame):\n        particles = self.particlesInFrame(frame)\n        num = float(particles.shape[0])\n        mean = 0.0\n        for p in particles:\n            mean += (1.0/num) * self.particleMeanVelocity(p[0])\n        return mean\n\n\n    def compare(self, db_file):\n        \n        c = self.cursor()\n        c.executescript(\"attach '{}' as d2;\".format(db_file))\n        \n        c.execute(\"\"\"\n            select a1.frame, count(*) / 2, sum(sqrt(power(a1.x - a2.x, 2) + power(a1.y - a2.y, 2))) / count(*)\n            from \n                (select * from assoc left join particles on assoc.particle = particles.id) as a1, \n                (select * from d2.assoc left join d2.particles on d2.assoc.particle = d2.particles.id) as a2\n            where a1.frame = a2.frame\n            and abs(a1.x - a2.x) < sqrt(a1.area)\n            and abs(a1.y - a2.y) < sqrt(a2.area)\n            and abs(a1.intensity - a2.intensity) < 35\n            group by a1.frame\n        \"\"\")\n        return np.array(c.fetchall())\n        \n        stats = []\n        return stats\n\n    \n    def toPng(self, bitmap):\n        data = png.from_array(bitmap, mode='L;1').save('tmp.png')\n        data = open('tmp.png').read()\n        data = buffer(data)\n        return data\n\n    \n    def fromPng(self, data):\n        im = png.Reader(bytes=data).asDirect()\n        return np.vstack(itertools.imap(np.uint8, im[2]))\n\n    \n    def getBitmap(self, frame_no):\n        res = self.query(\"SELECT bitmap FROM frames WHERE frame == \" + str(frame_no))\n        return self.fromPng(res[0][0])\n\n    def li_import(self, file_name):\n        with open(file_name) as file:\n            l = 0\n            for line in file:\n                l += 1\n                line = re.sub(' +',' ', re.sub('\\t',' ',line)).strip() # remove ws\n                line = np.array(line.split(\" \"), dtype=np.float64)\n                props = {\n                    \"frame\": line[0], \n                    \"area\": line[1], \n                    \"intensity\": line[2],\n                    \"category\": 2, # bitumen\n                    \"perimeter\": 0\n                }\n                points = line[3:]\n                samples = points.shape[0]\n                if samples % 2 == 1:\n                    raise ValueError(\"There must be equal number of x,y samples. Line \" + l)\n                points = points.reshape(2, samples/2).T\n                self.insertTrace(props, points)\n\n\n    \n        \n\ndef build_parser():\n    parser = ArgumentParser()\n    parser.add_argument('dbfile', help='database to operate on', default=\":memory:\")\n    parser.add_argument('action', help='command to execute [query, repl, compare]', default=\"\")\n    parser.add_argument('query', nargs='?', help='options for command', default=\"\")\n    parser.add_argument('-v', help='print verbose statements while executing', action='store_true')\n    return parser\n\n\nif __name__ == '__main__':\n    parser = build_parser()\n    options = parser.parse_args()\n    if options.dbfile != \":memory:\" and not os.path.isfile(options.dbfile):\n        if options.v:\n            self.say(\"Database file\", options.dbfile, \"does not exist. Creating.\")\n    bag = DataBag(options.dbfile, options.v)\n    \n    if options.action == \"query\":\n        print(bag.queryJSON(options.query))\n    \n    if options.action == \"repl\":\n        # TODO: accept stdin sql?\n        bag.repl()\n    \n    if options.action == \"compare\":\n        if not os.path.isfile(options.query):\n            parser.error(\"Comparision file %s does not exist.\" % options.query)\n        else:\n            stats = bag.compare(options.query)\n            print stats\n        \n        \n    if options.action == \"import\":\n        if not os.path.isfile(options.query):\n            parser.error(\"Import file %s does not exist.\" % options.query)\n        else:\n            bag.li_import(options.query)\n            \n    if options.action == \"debug\":\n        print bag.particlePoints(1)\n        print bag.particleMeanVelocity(1)\n        print bag.frameMeanVelocity(41)\n        print bag.frameMeanVelocity(42)\n        print bag.frameMeanVelocity(43)\n","undoManager":{"mark":12,"position":47,"stack":[[{"start":{"row":175,"column":44},"end":{"row":176,"column":0},"action":"insert","lines":["",""],"id":186},{"start":{"row":176,"column":0},"end":{"row":176,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":176,"column":8},"end":{"row":176,"column":25},"action":"insert","lines":["c = self.cursor()"],"id":187}],[{"start":{"row":176,"column":25},"end":{"row":177,"column":0},"action":"insert","lines":["",""],"id":188},{"start":{"row":177,"column":0},"end":{"row":177,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":177,"column":8},"end":{"row":177,"column":59},"action":"insert","lines":["c.execute(\"ALTER TABLE assoc ADD COLUMN crop BLOB\")"],"id":189}],[{"start":{"row":177,"column":48},"end":{"row":177,"column":52},"action":"remove","lines":["crop"],"id":190},{"start":{"row":177,"column":48},"end":{"row":177,"column":49},"action":"insert","lines":["s"]}],[{"start":{"row":177,"column":49},"end":{"row":177,"column":50},"action":"insert","lines":["c"],"id":191}],[{"start":{"row":177,"column":50},"end":{"row":177,"column":51},"action":"insert","lines":["a"],"id":192}],[{"start":{"row":177,"column":51},"end":{"row":177,"column":52},"action":"insert","lines":["l"],"id":193}],[{"start":{"row":177,"column":52},"end":{"row":177,"column":53},"action":"insert","lines":["e"],"id":194}],[{"start":{"row":177,"column":54},"end":{"row":177,"column":58},"action":"remove","lines":["BLOB"],"id":195},{"start":{"row":177,"column":54},"end":{"row":177,"column":55},"action":"insert","lines":["R"]}],[{"start":{"row":177,"column":55},"end":{"row":177,"column":56},"action":"insert","lines":["E"],"id":196}],[{"start":{"row":177,"column":56},"end":{"row":177,"column":57},"action":"insert","lines":["A"],"id":197}],[{"start":{"row":177,"column":57},"end":{"row":177,"column":58},"action":"insert","lines":["L"],"id":198}],[{"start":{"row":205,"column":4},"end":{"row":206,"column":0},"action":"insert","lines":["",""],"id":199},{"start":{"row":206,"column":0},"end":{"row":206,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":205,"column":4},"end":{"row":205,"column":5},"action":"insert","lines":["d"],"id":200}],[{"start":{"row":205,"column":5},"end":{"row":205,"column":6},"action":"insert","lines":["e"],"id":201}],[{"start":{"row":205,"column":6},"end":{"row":205,"column":7},"action":"insert","lines":["f"],"id":202}],[{"start":{"row":205,"column":7},"end":{"row":205,"column":8},"action":"insert","lines":[" "],"id":203}],[{"start":{"row":205,"column":8},"end":{"row":205,"column":9},"action":"insert","lines":["c"],"id":204}],[{"start":{"row":205,"column":9},"end":{"row":205,"column":10},"action":"insert","lines":["r"],"id":205}],[{"start":{"row":205,"column":10},"end":{"row":205,"column":11},"action":"insert","lines":["o"],"id":206}],[{"start":{"row":205,"column":11},"end":{"row":205,"column":12},"action":"insert","lines":["p"],"id":207}],[{"start":{"row":205,"column":12},"end":{"row":205,"column":14},"action":"insert","lines":["()"],"id":208}],[{"start":{"row":205,"column":13},"end":{"row":205,"column":14},"action":"insert","lines":["s"],"id":209}],[{"start":{"row":205,"column":14},"end":{"row":205,"column":15},"action":"insert","lines":["e"],"id":210}],[{"start":{"row":205,"column":15},"end":{"row":205,"column":16},"action":"insert","lines":["l"],"id":211}],[{"start":{"row":205,"column":16},"end":{"row":205,"column":17},"action":"insert","lines":["f"],"id":212}],[{"start":{"row":205,"column":17},"end":{"row":205,"column":18},"action":"insert","lines":[","],"id":213}],[{"start":{"row":205,"column":18},"end":{"row":205,"column":19},"action":"insert","lines":[" "],"id":214}],[{"start":{"row":205,"column":19},"end":{"row":205,"column":20},"action":"insert","lines":["f"],"id":215}],[{"start":{"row":205,"column":20},"end":{"row":205,"column":21},"action":"insert","lines":["r"],"id":216}],[{"start":{"row":205,"column":21},"end":{"row":205,"column":22},"action":"insert","lines":["a"],"id":217}],[{"start":{"row":205,"column":22},"end":{"row":205,"column":23},"action":"insert","lines":["m"],"id":218}],[{"start":{"row":205,"column":23},"end":{"row":205,"column":24},"action":"insert","lines":["e"],"id":219}],[{"start":{"row":205,"column":24},"end":{"row":205,"column":25},"action":"insert","lines":[","],"id":220}],[{"start":{"row":205,"column":25},"end":{"row":205,"column":26},"action":"insert","lines":[" "],"id":221}],[{"start":{"row":205,"column":26},"end":{"row":205,"column":27},"action":"insert","lines":["p"],"id":222}],[{"start":{"row":205,"column":27},"end":{"row":205,"column":28},"action":"insert","lines":["a"],"id":223}],[{"start":{"row":205,"column":28},"end":{"row":205,"column":29},"action":"insert","lines":["r"],"id":224}],[{"start":{"row":205,"column":29},"end":{"row":205,"column":30},"action":"insert","lines":["t"],"id":225}],[{"start":{"row":205,"column":30},"end":{"row":205,"column":31},"action":"insert","lines":["i"],"id":226}],[{"start":{"row":205,"column":31},"end":{"row":205,"column":32},"action":"insert","lines":["c"],"id":227}],[{"start":{"row":205,"column":32},"end":{"row":205,"column":33},"action":"insert","lines":["l"],"id":228}],[{"start":{"row":205,"column":33},"end":{"row":205,"column":34},"action":"insert","lines":["e"],"id":229}],[{"start":{"row":205,"column":35},"end":{"row":205,"column":36},"action":"insert","lines":["P"],"id":230}],[{"start":{"row":205,"column":35},"end":{"row":205,"column":36},"action":"remove","lines":["P"],"id":231}],[{"start":{"row":205,"column":35},"end":{"row":205,"column":36},"action":"insert","lines":[":"],"id":232}],[{"start":{"row":205,"column":36},"end":{"row":206,"column":0},"action":"insert","lines":["",""],"id":233},{"start":{"row":206,"column":0},"end":{"row":206,"column":8},"action":"insert","lines":["        "]}]]},"ace":{"folds":[],"scrolltop":2710,"scrollleft":0,"selection":{"start":{"row":206,"column":8},"end":{"row":206,"column":8},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":167,"state":"start","mode":"ace/mode/python"}},"timestamp":1503601408899}